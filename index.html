<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>勤怠・日報比較ツール (Ver.7.0)</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  
  <!-- Babel (JSX変換用) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- SheetJS (Excel操作用) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    body {
      background-color: #f8fafc; /* bg-slate-50 */
    }
    /* モーダル用のアニメーション */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-overlay {
      animation: fadeIn 0.2s ease-out;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useRef, useEffect } = React;

    // --- アイコン定義 ---
    const IconWrapper = ({ children, className = "w-5 h-5", ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const FileText = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" /></IconWrapper>;
    const Users = (p) => <IconWrapper {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></IconWrapper>;
    const CheckCircle2 = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></IconWrapper>;
    const ChevronRight = (p) => <IconWrapper {...p}><path d="m9 18 6-6-6-6" /></IconWrapper>;
    const Upload = (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></IconWrapper>;
    const Loader2 = ({ className, ...p }) => <IconWrapper className={`${className} animate-spin`} {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></IconWrapper>;
    const Zap = (p) => <IconWrapper {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconWrapper>;
    const Table = (p) => <IconWrapper {...p}><path d="M12 3v18" /><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M3 9h18" /><path d="M3 15h18" /></IconWrapper>;
    const FileSpreadsheet = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></IconWrapper>;
    const X = (p) => <IconWrapper {...p}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconWrapper>;
    const Trash2 = (p) => <IconWrapper {...p}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconWrapper>;
    const Settings = (p) => <IconWrapper {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
    const Save = (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
    const Download = (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconWrapper>;
    const AlertTriangle = (p) => <IconWrapper {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>;
    const Clock = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></IconWrapper>;
    const HelpCircle = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" /></IconWrapper>;
    const CalendarCheck = (p) => <IconWrapper {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /><path d="m9 16 2 2 4-4" /></IconWrapper>;
    const FolderInput = (p) => <IconWrapper {...p}><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><path d="M12 10v6"/><path d="M9 13h6"/></IconWrapper>;

    const useSheetJS = () => {
      const [xlsx, setXlsx] = useState(null);
      useEffect(() => {
        if (window.XLSX) { setXlsx(window.XLSX); return; }
        const interval = setInterval(() => {
          if (window.XLSX) { setXlsx(window.XLSX); clearInterval(interval); }
        }, 100);
        return () => clearInterval(interval);
      }, []);
      return xlsx;
    };

    // --- ヘルパー関数 ---
    const parseSpecialTime = (val) => {
      if (val === null || val === undefined || val === '') return 0;
      const str = String(val).trim().replace(',', '.');
      if (str.includes(':')) {
        const [h, m] = str.split(':').map(Number);
        return !isNaN(h) && !isNaN(m) ? h + (m / 60) : 0;
      }
      const floatVal = parseFloat(str);
      if (isNaN(floatVal)) return 0;
      const hours = Math.floor(floatVal);
      const minutes = Math.round((floatVal - hours) * 100);
      return hours + (minutes / 60);
    };

    const formatSpecialTime = (decimalHours) => {
      if (!decimalHours && decimalHours !== 0) return '-';
      const sign = decimalHours < 0 ? '-' : '';
      const absHours = Math.abs(decimalHours);
      const totalMinutes = Math.round(absHours * 60);
      const normH = Math.floor(totalMinutes / 60);
      const normM = totalMinutes % 60;
      return sign + (normH + (normM / 100)).toFixed(2);
    };

    const normalizeId = (id) => {
      if (!id) return '';
      const halfWidth = String(id).replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
      return halfWidth.replace(/^0+/, '').trim();
    };

    const normalizeName = (name) => {
      if (!name) return '';
      return String(name).replace(/[\s\u3000]+/g, '');
    };

    // --- ヘルプモーダル ---
    const HelpModal = ({ isOpen, onClose }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 modal-overlay" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
            <div className="p-6 border-b flex justify-between items-center bg-slate-50">
              <h2 className="text-lg font-bold flex items-center gap-2"><HelpCircle className="w-6 h-6 text-indigo-500" /> 整合性チェックのルール説明</h2>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-8 overflow-y-auto text-sm leading-relaxed text-slate-700 space-y-6">
              
              <section>
                <h3 className="font-bold text-indigo-600 border-b border-indigo-100 pb-1 mb-2">1. 時間の読み取りルール</h3>
                <p>本システムでは、時間入力の小数点以下を「分」として扱います（60進法）。</p>
                <ul className="list-disc list-inside ml-4 mt-1 space-y-1 bg-slate-50 p-3 rounded-lg">
                  <li><strong>2.10 (または 2.1)</strong> → <span className="font-bold">2時間10分</span></li>
                  <li><strong>2.30 (または 2.3)</strong> → <span className="font-bold">2時間30分</span>（2.5時間ではない）</li>
                  <li>計算時は分単位に変換して正確に合算します（例：1.30 + 1.30 = 3.00）。</li>
                </ul>
              </section>

              <section>
                <h3 className="font-bold text-indigo-600 border-b border-indigo-100 pb-1 mb-2">2. 勤務表の「所定内時間」計算式</h3>
                <p>勤務表ファイルには「所定内」の列がないため、以下の計算式で自動算出します。</p>
                <div className="mt-2 p-3 bg-slate-100 rounded-lg font-mono text-xs">
                  所定内 = (終業 - 始業) - 休憩 - 深夜休憩 - 時間外
                </div>
                <p className="mt-2 text-xs text-slate-500">※時間年休がある場合は、以下の条件分岐を行います：<br/>
                ・合計が8.0hになる場合(シフト変更) → 時間年休を引かない<br/>
                ・それ以外(中抜け) → 時間年休を引く
                </p>
              </section>

              <section>
                <h3 className="font-bold text-indigo-600 border-b border-indigo-100 pb-1 mb-2">3. 判定ロジックの種別</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="border rounded-xl p-4">
                    <h4 className="font-bold text-emerald-600 mb-2">一般社員</h4>
                    <ul className="list-disc list-inside space-y-1 text-xs">
                      <li>所定内、残業、深夜を個別に比較。</li>
                      <li><strong>夜業特例:</strong> 夜業をした場合、日報の所定内に「+8時間」されるルールに対応。<br/>(差分が-8.0hならOK、0hなら「未記入?」と警告)</li>
                    </ul>
                  </div>
                  <div className="border rounded-xl p-4">
                    <h4 className="font-bold text-orange-600 mb-2">フレックス (設定必要)</h4>
                    <ul className="list-disc list-inside space-y-1 text-xs">
                      <li><strong>合算比較:</strong> 勤務表の所定内 と (日報の所定内＋日報の残業) を比較します。</li>
                      <li>勤務表に「残業」が入力されていたらNG。</li>
                      <li>サマリーの日報欄は「所定内のみ」の合計を表示します。</li>
                    </ul>
                  </div>
                </div>
              </section>

              <section>
                <h3 className="font-bold text-indigo-600 border-b border-indigo-100 pb-1 mb-2">4. その他のチェック</h3>
                <ul className="list-disc list-inside ml-4 mt-1 space-y-1">
                  <li><strong>H列チェック:</strong> 日報(印刷用)のH列(214-221行)に数値があれば「H列不整合」警告。</li>
                  <li><strong>年休重複:</strong> 時間年休と残業が同時に入力されていたら警告。</li>
                  <li><strong>20日締め:</strong> 「20日締め」モード時は、21日以降のデータを無視して判定・集計します。</li>
                </ul>
              </section>

            </div>
            <div className="p-4 border-t bg-slate-50 text-right">
              <button onClick={onClose} className="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700">閉じる</button>
            </div>
          </div>
        </div>
      );
    };

    // --- 設定モーダル ---
    const SettingsModal = ({ isOpen, onClose, settings, onSave }) => {
      const [managersText, setManagersText] = useState('');
      const [flexText, setFlexText] = useState('');
      const [mappings, setMappings] = useState([]);
      const fileInput = useRef(null);

      useEffect(() => {
        if (isOpen) {
          setManagersText(settings.managers.join('\n'));
          setFlexText(settings.flexEmployees ? settings.flexEmployees.join('\n') : '');
          setMappings(settings.nameMappings);
        }
      }, [isOpen, settings]);

      const handleSave = () => {
        const newManagers = managersText.split('\n').map(s => normalizeName(s)).filter(s => s);
        const newFlex = flexText.split('\n').map(s => normalizeName(s)).filter(s => s);
        onSave({
          managers: newManagers,
          flexEmployees: newFlex,
          nameMappings: mappings.filter(m => m.nippo && m.kintai)
        });
        onClose();
      };

      const addMapping = () => setMappings([...mappings, { nippo: '', kintai: '' }]);
      const updateMapping = (idx, field, val) => {
        const newMappings = [...mappings];
        newMappings[idx][field] = val;
        setMappings(newMappings);
      };
      const removeMapping = (idx) => setMappings(mappings.filter((_, i) => i !== idx));

      const exportSettings = () => {
        const data = {
          managers: managersText.split('\n').map(s => s.trim()).filter(s => s),
          flexEmployees: flexText.split('\n').map(s => s.trim()).filter(s => s),
          nameMappings: mappings
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'attendance_settings.json';
        a.click();
      };

      const importSettings = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if (data.managers) setManagersText(data.managers.join('\n'));
            if (data.flexEmployees) setFlexText(data.flexEmployees.join('\n'));
            if (data.nameMappings) setMappings(data.nameMappings);
          } catch (err) { alert('設定ファイルの読み込みに失敗しました。'); }
        };
        reader.readAsText(file);
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 modal-overlay">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="p-6 border-b flex justify-between items-center bg-slate-50">
              <h2 className="text-lg font-bold flex items-center gap-2"><Settings className="w-5 h-5" />詳細設定</h2>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-6 overflow-y-auto flex-1 space-y-8">
              <div className="flex gap-3 pb-6 border-b">
                <button onClick={exportSettings} className="flex items-center gap-2 px-3 py-2 text-sm font-bold text-indigo-600 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition-colors"><Download className="w-4 h-4" /> 設定を保存(Export)</button>
                <button onClick={() => fileInput.current.click()} className="flex items-center gap-2 px-3 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors"><Upload className="w-4 h-4" /> 設定を読込(Import)</button>
                <input type="file" ref={fileInput} className="hidden" accept=".json" onChange={importSettings} />
              </div>
              <div className="grid grid-cols-2 gap-6">
                <div>
                  <h3 className="font-bold text-sm text-slate-700 mb-2">管理職リスト</h3>
                  <p className="text-xs text-slate-500 mb-2">夜業時の所定内8h加算なし</p>
                  <textarea value={managersText} onChange={e => setManagersText(e.target.value)} className="w-full h-32 p-3 border rounded-xl text-sm font-mono focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50" placeholder="氏名(1行1名)" />
                </div>
                <div>
                  <h3 className="font-bold text-sm text-slate-700 mb-2">フレックス対象者</h3>
                  <p className="text-xs text-slate-500 mb-2">勤務表所定 = 日報(所定+残業)</p>
                  <textarea value={flexText} onChange={e => setFlexText(e.target.value)} className="w-full h-32 p-3 border rounded-xl text-sm font-mono focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50" placeholder="氏名(1行1名)" />
                </div>
              </div>
              <div>
                <h3 className="font-bold text-sm text-slate-700 mb-2">旧姓・別名マッピング</h3>
                <p className="text-xs text-slate-500 mb-2">日報(旧姓) → 勤務表(新姓) に変換</p>
                <div className="space-y-2">
                  {mappings.map((m, i) => (
                    <div key={i} className="flex gap-2 items-center">
                      <input value={m.nippo} onChange={e => updateMapping(i, 'nippo', e.target.value)} placeholder="日報(旧姓)" className="flex-1 p-2 border rounded-lg text-sm bg-slate-50" />
                      <span className="text-slate-400">→</span>
                      <input value={m.kintai} onChange={e => updateMapping(i, 'kintai', e.target.value)} placeholder="勤務表(新姓)" className="flex-1 p-2 border rounded-lg text-sm bg-slate-50" />
                      <button onClick={() => removeMapping(i)} className="text-rose-400 hover:text-rose-600"><Trash2 className="w-4 h-4" /></button>
                    </div>
                  ))}
                  <button onClick={addMapping} className="text-xs font-bold text-indigo-600 hover:underline">+ 追加する</button>
                </div>
              </div>
            </div>
            <div className="p-4 border-t bg-slate-50 flex justify-end gap-3">
              <button onClick={onClose} className="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-200 rounded-lg">キャンセル</button>
              <button onClick={handleSave} className="px-6 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-lg shadow-indigo-200">設定を適用</button>
            </div>
          </div>
        </div>
      );
    };

    class AttendanceFileParser {
      constructor(xlsx) { this.xlsx = xlsx; }
      async parseFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = this.xlsx.read(data, { type: 'array', cellDates: false, codepage: 932, cellFormula: false });
              const rows = this.xlsx.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '', raw: false });
              resolve({ rows, fileName: file.name });
            } catch (error) { reject(error); }
          };
          reader.readAsArrayBuffer(file);
        });
      }
      async processFiles(files, settings) {
        const employees = {};
        for (const file of files) {
          try {
            const { rows, fileName } = await this.parseFile(file);
            const contentStr = rows.slice(0, 15).map(r => r.join(' ')).join(' ');
            
            let year = new Date().getFullYear();
            let month = new Date().getMonth() + 1;
            const ymMatch = contentStr.match(/(\d{4})年\s*(\d{1,2})月/) || contentStr.match(/年度\s*(\d{4})\s*,\s*月度\s*(\d{1,2})/);
            if (ymMatch) {
              year = parseInt(ymMatch[1]);
              month = parseInt(ymMatch[2]);
            }

            const isDailyReportData = contentStr.includes('工事番号') && contentStr.includes('所定内') && !contentStr.includes('行番号');
            const isDailyReportPrint = contentStr.includes('勤務日報') && (contentStr.includes('行番号') || fileName.includes('印刷用') || fileName.toLowerCase().endsWith('.xls'));
            const isSchedule = contentStr.includes('勤務表') || (contentStr.includes('日付') && contentStr.includes('勤務状況'));

            const context = { year, month };

            if (isDailyReportData) this.parseDailyReport_DataFormat(rows, employees, settings, context);
            else if (isDailyReportPrint) this.parseDailyReport_PrintFormat(rows, employees, settings, context);
            else if (isSchedule) this.parseSchedule(rows, employees, settings, context);
          } catch (e) { console.error(e); }
        }
        return employees;
      }
      resolveEmployee(employees, id, name, settings) {
        const normId = normalizeId(id);
        const normName = normalizeName(name);
        if (normId && employees[normId]) return normId;
        let targetCanonicalName = normName;
        if (settings && settings.nameMappings) {
          const mapping = settings.nameMappings.find(m => normalizeName(m.nippo) === normName || normalizeName(m.kintai) === normName);
          if (mapping) targetCanonicalName = normalizeName(mapping.kintai);
        }
        const foundId = Object.keys(employees).find(key => {
          const emp = employees[key];
          const empNameNorm = normalizeName(emp.employeeName);
          let empCanonicalName = empNameNorm;
          if (settings && settings.nameMappings) {
            const m = settings.nameMappings.find(map => normalizeName(map.nippo) === empNameNorm || normalizeName(map.kintai) === empNameNorm);
            if (m) empCanonicalName = normalizeName(m.kintai);
          }
          return empCanonicalName === targetCanonicalName;
        });
        return foundId || normId || `TEMP-${targetCanonicalName}`;
      }
      initEmployee(employees, id, name, year, month) {
        if (!employees[id]) {
          employees[id] = { 
            employeeId: id, 
            employeeName: name || `Employee-${id}`, 
            schedule: [], report: [], 
            year: year, month: month, 
            warnings: [] 
          };
        } else {
          if (name && !employees[id].employeeName.match(/^[^\s]+$/)) employees[id].employeeName = name;
          if (!employees[id].year && year) { employees[id].year = year; employees[id].month = month; }
        }
      }
      upsertRecord(array, record) {
        const idx = array.findIndex(r => r.day === record.day);
        if (idx >= 0) {
          const existing = array[idx];
          array[idx] = {
            ...existing, ...record,
            regularTime: (existing.regularTime || 0) + (record.regularTime || 0),
            overtime: (existing.overtime || 0) + (record.overtime || 0),
            nightTime: (existing.nightTime || 0) + (record.nightTime || 0),
            holidayWork: (existing.holidayWork || 0) + (record.holidayWork || 0),
            status: record.status || existing.status,
            weekday: record.weekday || existing.weekday, 
            startTime: record.startTime || existing.startTime,
            endTime: record.endTime || existing.endTime,
            timeAnnualLeave: record.timeAnnualLeave || existing.timeAnnualLeave
          };
        } else { array.push(record); }
      }
      parseSchedule(rows, employees, settings, ctx) {
        let currentEmployeeId = null;
        let currentEmployeeName = null;
        let colMap = null;
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i] || [];
          const rowStr = row.join(' ');
          if (rowStr.includes('社員番号')) {
            const idMatch = rowStr.match(/社員番号[\s:：]*(\d{5,10})/);
            if (idMatch) {
              const rawName = rowStr.match(/(?:氏名|氏　名)[\s:：]*([^\s,0-9]+(?:\s+[^\s,0-9]+)?)/)?.[1];
              currentEmployeeId = this.resolveEmployee(employees, idMatch[1], rawName, settings);
              currentEmployeeName = normalizeName(rawName);
              this.initEmployee(employees, currentEmployeeId, currentEmployeeName, ctx.year, ctx.month);
            }
          }
          if (!colMap && (row.includes('日付') || row.includes('勤務状況'))) {
            colMap = {
              day: row.findIndex(c => c && c.includes('日付')),
              weekday: row.findIndex(c => c && c.includes('曜日')),
              status: row.findIndex(c => c && c.includes('勤務状況')),
              start: row.findIndex(c => c && (c.includes('始業') || c.includes('開始'))),
              end: row.findIndex(c => c && (c.includes('終業') || c.includes('終了'))),
              breakTime: row.findIndex(c => c && c.includes('休憩') && !c.includes('深夜')),
              nightBreak: row.findIndex(c => c && c.includes('深夜') && c.includes('休憩')),
              overtime: row.findIndex(c => c && c.includes('時間外') && !c.includes('法内') && !c.includes('深夜')),
              night: row.findIndex(c => c && c.includes('深夜') && !c.includes('休憩')),
              timeAnnualLeave: 14 
            };
            if (colMap.day === -1) colMap.day = 0;
            if (colMap.weekday === -1) colMap.weekday = 1;
            if (colMap.nightBreak === -1) colMap.nightBreak = 12;
            continue;
          }
          if (currentEmployeeId && colMap) {
            const colA = String(row[colMap.day] || '').trim();
            if (colA === '合計') { currentEmployeeId = null; continue; }
            const dayVal = parseInt(colA, 10);
            if (!isNaN(dayVal) && dayVal >= 1 && dayVal <= 31) {
              const startStr = row[colMap.start];
              const endStr = row[colMap.end];
              const breakTime = parseSpecialTime(row[colMap.breakTime]);
              const nightBreakTime = parseSpecialTime(row[colMap.nightBreak]);
              const overtime = parseSpecialTime(row[colMap.overtime]);
              const timeAnnualLeave = parseSpecialTime(row[colMap.timeAnnualLeave]);
              const weekdayStr = String(row[colMap.weekday] || '').trim();
              
              let regularTime = 0;
              if (startStr && endStr) {
                let s = parseSpecialTime(startStr);
                let e = parseSpecialTime(endStr);
                if (e < s) e += 24;
                const actualWork = (e - s) - breakTime - nightBreakTime;
                if (timeAnnualLeave > 0) {
                  if (Math.abs((actualWork + timeAnnualLeave) - 8.0) < 0.01) { regularTime = actualWork; } 
                  else { regularTime = Math.max(0, actualWork - timeAnnualLeave); }
                } else {
                  regularTime = Math.max(0, actualWork - overtime);
                }
              }
              this.upsertRecord(employees[currentEmployeeId].schedule, {
                day: dayVal,
                weekday: weekdayStr,
                status: String(row[colMap.status] || ''),
                startTime: startStr ? String(startStr) : '',
                endTime: endStr ? String(endStr) : '',
                overtime, regularTime, timeAnnualLeave,
                nightTime: parseSpecialTime(row[colMap.night])
              });
            }
          }
        }
      }
      
      parseDailyReport_DataFormat(rows, employees, settings, ctx) {
        let currentEmployeeId = null;
        let colMap = null;
        let headerRowIdx = -1;
        for (let i = 0; i < 20 && i < rows.length; i++) {
          const row = rows[i];
          if (!currentEmployeeId) {
            const idIdx = row.findIndex(c => String(c).includes('社員番号'));
            const nameIdx = row.findIndex(c => String(c).includes('社員名'));
            if (idIdx !== -1 && row[idIdx + 1]) {
              const rawName = (nameIdx !== -1 && row[nameIdx + 1]) ? String(row[nameIdx + 1]) : '';
              currentEmployeeId = this.resolveEmployee(employees, row[idIdx + 1], rawName, settings);
              this.initEmployee(employees, currentEmployeeId, normalizeName(rawName), ctx.year, ctx.month);
            }
          }
          if (row.includes('工事番号') && row.includes('所定内')) {
            headerRowIdx = i;
            colMap = {
              day: row.findIndex(c => c === '日'),
              regular: row.findIndex(c => c.includes('所定内')),
              overtime: row.findIndex(c => c.includes('時間外')),
              night: row.findIndex(c => c.includes('深夜')),
              holiday: row.findIndex(c => c.includes('休日')),
            };
            break;
          }
        }
        if (!currentEmployeeId || !colMap) return;
        for (let i = headerRowIdx + 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row) continue;
          const dayVal = parseInt(row[colMap.day], 10);
          if (!isNaN(dayVal) && dayVal >= 1 && dayVal <= 31) {
            const regular = parseSpecialTime(row[colMap.regular]);
            const overtime = parseSpecialTime(row[colMap.overtime]);
            const holiday = parseSpecialTime(row[colMap.holiday]);
            this.upsertRecord(employees[currentEmployeeId].report, {
              day: dayVal, regularTime: regular, overtime: overtime,
              nightTime: parseSpecialTime(row[colMap.night]), holidayWork: holiday,
              status: (regular > 0 || overtime > 0 || holiday > 0) ? '出勤' : '',
              startTime: '記録あり'
            });
          }
        }
      }
      
      parseDailyReport_PrintFormat(rows, employees, settings, ctx) {
        let currentEmployeeId = null;
        const COL = { DATE: 3, REGULAR: 26, OVERTIME: 29, NIGHT: 32, HOLIDAY: 35, NAME: 32 };
        let rawName = '';
        if (rows[7] && rows[7][COL.NAME]) rawName = String(rows[7][COL.NAME]);
        for (let i = 0; i < 10; i++) {
          const rowStr = (rows[i] || []).join(' ');
          const idMatch = rowStr.match(/社員番号[\s:：]*(\d{5,10})/);
          if (idMatch) { currentEmployeeId = this.resolveEmployee(employees, idMatch[1], rawName, settings); break; }
        }
        if (!currentEmployeeId && rawName) currentEmployeeId = this.resolveEmployee(employees, null, rawName, settings);
        if (!currentEmployeeId) return;
        this.initEmployee(employees, currentEmployeeId, normalizeName(rawName), ctx.year, ctx.month);

        for(let r = 213; r <= 220; r++) {
          if (rows[r] && parseFloat(rows[r][7]) !== 0 && !isNaN(parseFloat(rows[r][7]))) {
            if (!employees[currentEmployeeId].warnings.includes('H列不整合')) {
              employees[currentEmployeeId].warnings.push('H列不整合');
            }
          }
        }

        for (let i = 10; i < rows.length; i++) {
          const row = rows[i] || [];
          const dayValRaw = row[COL.DATE];
          if (dayValRaw == 0 || dayValRaw === '0') break;
          const dayVal = parseInt(dayValRaw, 10);
          if (!isNaN(dayVal) && dayVal >= 1 && dayVal <= 31) {
            const regular = parseSpecialTime(row[COL.REGULAR]);
            const overtime = parseSpecialTime(row[COL.OVERTIME]);
            const holiday = parseSpecialTime(row[COL.HOLIDAY]);
            this.upsertRecord(employees[currentEmployeeId].report, {
              day: dayVal, regularTime: regular, overtime: overtime,
              nightTime: parseSpecialTime(row[COL.NIGHT]), holidayWork: holiday,
              status: (regular > 0 || overtime > 0 || holiday > 0) ? '出勤' : '',
              startTime: '記録あり'
            });
          }
        }
      }
    }

    function App() {
      const [files, setFiles] = useState([]);
      const [isProcessing, setIsProcessing] = useState(false);
      const [employees, setEmployees] = useState({}); 
      const [selectedId, setSelectedId] = useState(null);
      const [view, setView] = useState('input');
      const [showSettings, setShowSettings] = useState(false);
      const [showHelp, setShowHelp] = useState(false);
      const [checkMode, setCheckMode] = useState('full'); // 'full' or 'day20'
      const [settings, setSettings] = useState({ managers: [], flexEmployees: [], nameMappings: [] });
      const [mismatchListOpen, setMismatchListOpen] = useState(false);
      const fileInputRef = useRef(null);
      const folderInputRef = useRef(null);
      const xlsx = useSheetJS();

      useEffect(() => {
        if (folderInputRef.current) {
          folderInputRef.current.setAttribute('webkitdirectory', '');
          folderInputRef.current.setAttribute('directory', '');
        }
      }, [view]);

      const onFileChange = (e) => setFiles(prev => [...prev, ...Array.from(e.target.files || [])]);
      const removeFile = (index) => setFiles(prev => prev.filter((_, i) => i !== index));

      // 共通: 不整合チェック (limitDay対応)
      const checkDailyMismatch = (sch, rep, isManager, isFlex) => {
        let diffOvertime = (sch.overtime || 0) - (rep.overtime || 0);
        let diffRegular = (sch.regularTime || 0) - (rep.regularTime || 0);
        let diffNight = (sch.nightTime || 0) - (rep.nightTime || 0);
        
        let isSpecialCase = false;
        let warningMessage = '';
        let hasMismatch = false;

        if (sch.timeAnnualLeave > 0 && sch.overtime > 0) {
          warningMessage = '年休+残業NG';
          hasMismatch = true;
        }

        if (isFlex) {
          if (sch.overtime > 0) { warningMessage = 'FLEX:勤務表に残業NG'; hasMismatch = true; }
          const flexRegularDiff = (sch.regularTime || 0) - ((rep.regularTime || 0) + (rep.overtime || 0));
          if (Math.abs(flexRegularDiff) > 0.01) hasMismatch = true;
          if (!hasMismatch) { diffRegular = 0; isSpecialCase = true; } else { diffRegular = flexRegularDiff; }
          diffOvertime = 0;
        } else {
          const hasNightWorkInReport = (rep.nightTime > 0) || (rep.status === '夜業') || (rep.status === '出勤' && rep.nightTime > 0);
          if (!isManager && hasNightWorkInReport) {
            if (Math.abs(diffRegular + 8.0) < 0.1) { diffRegular = 0; isSpecialCase = true; } 
            else if (Math.abs(diffRegular) < 0.1) { warningMessage = '日報所定内8h未記入?'; hasMismatch = true; }
            else { hasMismatch = true; }
          } else {
            if (Math.abs(diffRegular) > 0.01) hasMismatch = true;
          }
          if (Math.abs(diffOvertime) > 0.01) hasMismatch = true;
        }
        if (Math.abs(diffNight) > 0.01) hasMismatch = true;

        return { diffRegular, diffOvertime, diffNight, isSpecialCase, warningMessage, hasMismatch };
      };

      const analyzeEmployeeMismatch = (emp, isManager, isFlex, limitDay) => {
        if (emp.warnings && emp.warnings.includes('H列不整合')) return true;
        let hasError = false;
        for (let day = 1; day <= limitDay; day++) {
          const sch = emp.schedule.find(r => r.day === day) || {};
          const rep = emp.report.find(r => r.day === day) || {};
          if (sch.status || rep.status || sch.overtime > 0 || rep.overtime > 0) {
            const res = checkDailyMismatch(sch, rep, isManager, isFlex);
            if (res.hasMismatch) { hasError = true; break; }
          }
        }
        return hasError;
      };

      const employeeSummary = useMemo(() => {
        const list = Object.values(employees);
        let managerCount = 0;
        let generalCount = 0;
        let mismatchEmployees = [];
        const limitDay = checkMode === 'day20' ? 20 : 31;

        list.forEach(emp => {
          let currentName = normalizeName(emp.employeeName);
          if (settings.nameMappings) {
            const mapping = settings.nameMappings.find(m => normalizeName(m.nippo) === currentName || normalizeName(m.kintai) === currentName);
            if (mapping) currentName = normalizeName(mapping.nippo);
          }
          let isManager = settings.managers.includes(currentName);
          let isFlex = settings.flexEmployees.includes(currentName);
          if (!isManager && settings.nameMappings) {
             const mapping = settings.nameMappings.find(m => normalizeName(m.nippo) === currentName || normalizeName(m.kintai) === currentName);
             if (mapping) {
               const mapName = normalizeName(mapping.kintai);
               if (settings.managers.includes(mapName)) isManager = true;
               if (settings.flexEmployees.includes(mapName)) isFlex = true;
             }
          }
          if (isManager) managerCount++; else generalCount++;
          if (analyzeEmployeeMismatch(emp, isManager, isFlex, limitDay)) mismatchEmployees.push(emp);
        });
        return { managerCount, generalCount, mismatchEmployees };
      }, [employees, settings, checkMode]);

      const handleProcess = async () => {
        if (files.length === 0 || !xlsx) return;
        setIsProcessing(true);
        try {
          const parser = new AttendanceFileParser(xlsx);
          const parsedData = await parser.processFiles(files, settings);
          setEmployees(prev => {
            const next = { ...prev };
            Object.values(parsedData).forEach(newEmp => {
              let targetKey = newEmp.employeeId;
              if (next[targetKey]) {
                const existing = next[targetKey];
                newEmp.schedule.forEach(r => parser.upsertRecord(existing.schedule, r));
                newEmp.report.forEach(r => parser.upsertRecord(existing.report, r));
                if (newEmp.warnings) {
                  existing.warnings = [...(existing.warnings || []), ...newEmp.warnings];
                }
                if (settings.nameMappings) {
                  const mapping = settings.nameMappings.find(m => normalizeName(m.nippo) === normalizeName(newEmp.employeeName) || normalizeName(m.kintai) === normalizeName(newEmp.employeeName));
                  if (mapping) existing.employeeName = mapping.nippo;
                  else if (newEmp.employeeName && newEmp.employeeName.length > existing.employeeName.length) existing.employeeName = newEmp.employeeName;
                }
              } else {
                if (settings.nameMappings) {
                  const mapping = settings.nameMappings.find(m => normalizeName(m.nippo) === normalizeName(newEmp.employeeName) || normalizeName(m.kintai) === normalizeName(newEmp.employeeName));
                  if (mapping) newEmp.employeeName = mapping.nippo;
                }
                next[targetKey] = newEmp;
              }
            });
            return next;
          });
          setFiles([]);
          if (fileInputRef.current) fileInputRef.current.value = "";
          if (folderInputRef.current) folderInputRef.current.value = "";
          setView('dashboard');
        } catch (error) { alert(`エラー: ${error.message}`); } finally { setIsProcessing(false); }
      };

      const employeeList = useMemo(() => Object.values(employees), [employees]);
      const currentEmployee = employees[selectedId] || employeeList[0];

      const comparisonData = useMemo(() => {
        if (!currentEmployee) return [];
        const currentNameNorm = normalizeName(currentEmployee.employeeName);
        let isManager = settings.managers.includes(currentNameNorm);
        let isFlex = settings.flexEmployees.includes(currentNameNorm);
        if (settings.nameMappings) {
          const mapping = settings.nameMappings.find(m => normalizeName(m.nippo) === currentNameNorm || normalizeName(m.kintai) === currentNameNorm);
          if (mapping) {
            const mapName = normalizeName(mapping.kintai);
            if (settings.managers.includes(mapName)) isManager = true;
            if (settings.flexEmployees.includes(mapName)) isFlex = true;
          }
        }
        
        const limitDay = checkMode === 'day20' ? 20 : 31;
        return Array.from({ length: 31 }, (_, i) => i + 1)
          .filter(day => day <= limitDay)
          .map(day => {
            const sch = currentEmployee.schedule.find(r => r.day === day) || {};
            const rep = currentEmployee.report.find(r => r.day === day) || {};
            const check = checkDailyMismatch(sch, rep, isManager, isFlex);
            
            let rowColor = '';
            const weekday = sch.weekday || '';
            const status = sch.status || '';

            if (status.includes('加休')) { rowColor = 'bg-red-50'; } 
            else if (weekday.includes('日')) { rowColor = 'bg-red-50'; } 
            else if (weekday.includes('土')) { rowColor = 'bg-blue-50'; }

            return { 
              day, weekday, rowColor,
              sch, rep, ...check, hasData: sch.status || rep.status || sch.overtime > 0 || rep.overtime > 0 || sch.regularTime > 0 || rep.regularTime > 0, hasHolidayWork: rep.holidayWork > 0 
            };
          }).filter(d => d.hasData);
      }, [currentEmployee, settings, checkMode]);

      const selectEmployeeByKey = (emp) => setSelectedId(Object.keys(employees).find(k => employees[k] === emp));

      return (
        <div className="min-h-screen bg-slate-50 text-slate-900 p-4 md:p-8 pb-20">
          <header className="max-w-7xl mx-auto mb-6 flex flex-col md:flex-row items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <div className="bg-indigo-600 p-2 rounded-xl text-white shadow-lg"><Zap className="w-6 h-6" /></div>
              <div><h1 className="text-xl font-bold text-slate-800">勤怠データ照合ツール (Ver.7.0)</h1><p className="text-xs text-slate-500 font-medium">20日締めモード・ヘルプ・H列チェック</p></div>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setShowHelp(true)} className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-bold bg-white text-emerald-600 border border-emerald-200 hover:bg-emerald-50 transition-colors"><HelpCircle className="w-4 h-4" /> ヘルプ</button>
              <button onClick={() => setShowSettings(true)} className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold bg-white text-slate-600 border hover:bg-slate-50 transition-colors"><Settings className="w-4 h-4" /> 設定</button>
              <div className="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                <button onClick={() => setView('input')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${view === 'input' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>ファイル登録</button>
                <button onClick={() => setView('dashboard')} disabled={employeeList.length === 0} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${view === 'dashboard' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50 disabled:opacity-30'}`}>比較ボード</button>
              </div>
            </div>
          </header>
          <main className="max-w-7xl mx-auto">
            {view === 'input' ? (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-6">
                  <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden">
                    {/* ... (Upload UI) ... */}
                    <div className="flex items-center gap-2 mb-4"><div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><FileSpreadsheet className="w-5 h-5" /></div><h2 className="font-bold">ファイルアップロード</h2></div>
                    <div className="flex gap-4">
                      <div className={`flex-1 border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center transition-all cursor-pointer group ${!xlsx ? 'opacity-50 pointer-events-none' : 'hover:border-indigo-400 hover:bg-indigo-50/50'}`} onClick={() => fileInputRef.current?.click()}>
                        <input type="file" ref={fileInputRef} className="hidden" multiple accept=".xls, .xlsx, .csv" onChange={onFileChange} />
                        <Upload className="w-8 h-8 mx-auto mb-2 text-slate-300 group-hover:text-indigo-500 transition-colors" />
                        <p className="text-sm font-bold text-slate-600">ファイルを選択</p>
                      </div>
                      <div className={`flex-1 border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center transition-all cursor-pointer group ${!xlsx ? 'opacity-50 pointer-events-none' : 'hover:border-indigo-400 hover:bg-indigo-50/50'}`} onClick={() => folderInputRef.current?.click()}>
                        <input type="file" ref={folderInputRef} className="hidden" multiple onChange={onFileChange} />
                        <FolderInput className="w-8 h-8 mx-auto mb-2 text-slate-300 group-hover:text-indigo-500 transition-colors" />
                        <p className="text-sm font-bold text-slate-600">フォルダを選択</p>
                      </div>
                    </div>
                    
                    {files.length > 0 && (
                      <>
                        <div className="mt-4 flex justify-between items-center text-sm font-bold text-slate-500 border-b pb-2">
                          <span>選択中のファイル ({files.length})</span>
                          <button onClick={() => setFiles([])} className="text-xs text-rose-500 hover:underline">すべて削除</button>
                        </div>
                        <div className="mt-2 space-y-2 max-h-40 overflow-y-auto">{files.map((file, idx) => (<div key={idx} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 text-sm"><span className="font-bold text-slate-700 truncate flex items-center gap-2"><FileText className="w-4 h-4 text-indigo-500" />{file.name}</span><button onClick={() => removeFile(idx)} className="text-slate-400 hover:text-rose-500 p-2"><X className="w-4 h-4" /></button></div>))}</div>
                      </>
                    )}
                  </div>
                  
                  {/* チェックモード選択 */}
                  <div className="flex justify-center bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                    <button onClick={() => setCheckMode('full')} className={`flex-1 px-4 py-3 rounded-lg text-sm font-bold transition-all ${checkMode === 'full' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>通常 (月末まで)</button>
                    <button onClick={() => setCheckMode('day20')} className={`flex-1 px-4 py-3 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 ${checkMode === 'day20' ? 'bg-amber-500 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}><CalendarCheck className="w-4 h-4" /> 20日締め</button>
                  </div>

                  <button onClick={handleProcess} disabled={isProcessing || files.length === 0} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white font-black rounded-2xl transition-all flex items-center justify-center gap-3 shadow-xl shadow-indigo-200 active:scale-95">{isProcessing ? <><Loader2 className="w-6 h-6 animate-spin" />解析中...</> : <><Table className="w-6 h-6" />解析を実行</>}</button>
                </div>
                <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 h-fit"><h3 className="font-bold mb-4 flex items-center gap-2 border-b pb-4"><Users className="w-5 h-5 text-indigo-600" />解析済みデータ ({employeeList.length})</h3>
                  <div className="space-y-2 max-h-[600px] overflow-y-auto">{employeeList.map((emp, i) => (<div key={i} className="p-3 border rounded-xl bg-slate-50/50 flex items-center justify-between"><div><div className="text-[9px] font-mono text-slate-400">ID: {emp.employeeId}</div><div className="text-sm font-bold text-slate-700">{emp.employeeName}</div></div></div>))}</div>
                </div>
              </div>
            ) : (
              <div className="flex flex-col gap-6">
                <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-6 items-start">
                  <div className="flex gap-4 p-2"><div className="text-center px-4 border-r"><div className="text-xs text-slate-400 font-bold mb-1">管理職</div><div className="text-2xl font-black text-slate-700">{employeeSummary.managerCount} <span className="text-sm font-normal text-slate-400">名</span></div></div><div className="text-center px-4"><div className="text-xs text-slate-400 font-bold mb-1">一般社員</div><div className="text-2xl font-black text-slate-700">{employeeSummary.generalCount} <span className="text-sm font-normal text-slate-400">名</span></div></div></div>
                  <div className="flex-1 w-full">
                    <div className={`flex items-center justify-between p-3 rounded-xl cursor-pointer transition-colors ${employeeSummary.mismatchEmployees.length > 0 ? 'bg-rose-50 hover:bg-rose-100 text-rose-800' : 'bg-emerald-50 text-emerald-800'}`} onClick={() => setMismatchListOpen(!mismatchListOpen)}>
                      <div className="flex items-center gap-2 font-bold">{employeeSummary.mismatchEmployees.length > 0 ? <AlertTriangle className="w-5 h-5" /> : <CheckCircle2 className="w-5 h-5" />}不整合あり: {employeeSummary.mismatchEmployees.length} 名 {checkMode === 'day20' && <span className="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full ml-2">20日〆</span>}</div>
                      <ChevronRight className={`w-5 h-5 transition-transform ${mismatchListOpen ? 'rotate-90' : ''}`} />
                    </div>
                    {mismatchListOpen && employeeSummary.mismatchEmployees.length > 0 && <div className="mt-2 p-2 bg-white border border-rose-100 rounded-xl shadow-sm grid grid-cols-2 md:grid-cols-4 gap-2">{employeeSummary.mismatchEmployees.map(emp => (<button key={emp.employeeId} onClick={() => selectEmployeeByKey(emp)} className="text-left px-3 py-2 text-sm font-bold text-rose-600 hover:bg-rose-50 rounded-lg truncate flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-rose-500 inline-block flex-shrink-0"></span>{emp.employeeName}{emp.warnings && emp.warnings.includes('H列不整合') && <span className="text-[9px] bg-black text-white px-1 rounded">H列</span>}</button>))}</div>}
                  </div>
                </div>
                <div className="flex flex-col lg:flex-row gap-6">
                  <aside className="w-full lg:w-64 space-y-2 shrink-0 max-h-[80vh] overflow-y-auto">
                    <h3 className="text-[10px] font-black text-slate-400 px-3 py-1 uppercase tracking-widest flex justify-between items-center">
                      Employee List
                      {checkMode === 'day20' && <span className="text-[9px] bg-amber-500 text-white px-1 rounded">20日〆</span>}
                    </h3>
                    {employeeList.map((emp) => {
                      const key = Object.keys(employees).find(k => employees[k] === emp);
                      const isMismatch = employeeSummary.mismatchEmployees.includes(emp);
                      const normName = normalizeName(emp.employeeName);
                      let isManager = settings.managers.includes(normName);
                      let isFlex = settings.flexEmployees.includes(normName);
                      if (settings.nameMappings) {
                        const m = settings.nameMappings.find(map => normalizeName(map.nippo) === normName || normalizeName(map.kintai) === normName);
                        if(m) {
                           const kn = normalizeName(m.kintai);
                           if(settings.managers.includes(kn)) isManager=true;
                           if(settings.flexEmployees.includes(kn)) isFlex=true;
                        }
                      }

                      return (<button key={key} onClick={() => setSelectedId(key)} className={`w-full p-3 rounded-2xl text-left transition-all flex items-center justify-between border ${selectedId === key ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg scale-105 z-10' : 'bg-white border-slate-200 hover:bg-slate-50'}`}><div className="truncate flex-1"><div className={`text-[9px] font-mono ${selectedId === key ? 'text-indigo-200' : 'text-slate-400'}`}>{emp.employeeId}</div><div className="font-bold truncate text-sm flex items-center gap-1">{emp.employeeName}{isManager && <span className="text-[9px] bg-purple-100 text-purple-700 px-1 rounded">管</span>}{isFlex && <span className="text-[9px] bg-orange-100 text-orange-700 px-1 rounded">F</span>}{isMismatch && <span className="w-2 h-2 rounded-full bg-rose-500"></span>}</div></div><ChevronRight className={`w-4 h-4 shrink-0 ${selectedId === key ? 'opacity-100' : 'opacity-20'}`} /></button>);
                    })}
                  </aside>
                  <div className="flex-1 space-y-4">
                    {!currentEmployee ? (
                      <div className="bg-white h-[400px] rounded-3xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400"><p className="font-bold text-sm">社員を選択してください</p></div>
                    ) : (
                      <>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                            <div className="text-[10px] font-black text-slate-400 uppercase mb-2">所定内 勤務時間</div>
                            <div className="flex justify-between items-end mb-1">
                              <div><span className="text-xs text-slate-400 block">勤務表(計算)</span><span className="text-xl font-mono font-bold text-slate-700">{formatSpecialTime(comparisonData.reduce((acc, d) => acc + (d.sch.regularTime || 0), 0))}</span></div>
                              <div className="text-right">
                                <span className="text-xs text-slate-400 block">日報({settings.flexEmployees.includes(normalizeName(currentEmployee.employeeName)) ? '所定のみ' : '合計'})</span>
                                <span className="text-xl font-mono font-bold text-blue-600">
                                  {formatSpecialTime(comparisonData.reduce((acc, d) => acc + (d.rep.regularTime || 0), 0))}
                                </span>
                              </div>
                            </div>
                            <div className={`text-right text-xs font-bold ${Math.abs(comparisonData.reduce((acc, d) => acc + d.diffRegular, 0)) > 0.01 ? 'text-rose-500' : 'text-emerald-500'}`}>
                              {settings.flexEmployees.includes(normalizeName(currentEmployee.employeeName)) ? 'FLEX判定' : `Diff: ${formatSpecialTime(comparisonData.reduce((acc, d) => acc + d.diffRegular, 0))}`}
                            </div>
                          </div>
                          <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                            <div className="text-[10px] font-black text-slate-400 uppercase mb-2">残業時間</div>
                            <div className="flex justify-between items-end mb-1">
                              <div><span className="text-xs text-slate-400 block">勤務表</span><span className="text-xl font-mono font-bold text-slate-700">{formatSpecialTime(comparisonData.reduce((acc, d) => acc + (d.sch.overtime || 0), 0))}</span></div>
                              <div className="text-right"><span className="text-xs text-slate-400 block">日報</span><span className="text-xl font-mono font-bold text-blue-600">{formatSpecialTime(comparisonData.reduce((acc, d) => acc + (d.rep.overtime || 0), 0))}</span></div>
                            </div>
                            <div className={`text-right text-xs font-bold ${Math.abs(comparisonData.reduce((acc, d) => acc + d.diffOvertime, 0)) > 0.01 ? 'text-rose-500' : 'text-emerald-500'}`}>Diff: {formatSpecialTime(comparisonData.reduce((acc, d) => acc + d.diffOvertime, 0))}</div>
                          </div>
                          <div className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
                            <div className="text-[10px] font-black text-slate-400 uppercase mb-2">深夜時間</div>
                            <div className="flex justify-between items-end mb-1">
                              <div><span className="text-xs text-slate-400 block">勤務表</span><span className="text-xl font-mono font-bold text-slate-700">{formatSpecialTime(comparisonData.reduce((acc, d) => acc + (d.sch.nightTime || 0), 0))}</span></div>
                              <div className="text-right"><span className="text-xs text-slate-400 block">日報</span><span className="text-xl font-mono font-bold text-blue-600">{formatSpecialTime(comparisonData.reduce((acc, d) => acc + (d.rep.nightTime || 0), 0))}</span></div>
                            </div>
                            <div className={`text-right text-xs font-bold ${Math.abs(comparisonData.reduce((acc, d) => acc + d.diffNight, 0)) > 0.01 ? 'text-rose-500' : 'text-emerald-500'}`}>Diff: {formatSpecialTime(comparisonData.reduce((acc, d) => acc + d.diffNight, 0))}</div>
                          </div>
                        </div>
                        
                        {currentEmployee.warnings && currentEmployee.warnings.length > 0 && (
                          <div className="mt-4 p-3 bg-red-100 border border-red-200 text-red-800 rounded-xl text-sm font-bold flex gap-2 items-center">
                            <AlertTriangle className="w-5 h-5"/>
                            重要警告: {currentEmployee.warnings.join(', ')}
                          </div>
                        )}

                        <div className="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden mt-6">
                          <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                              <thead>
                                <tr className="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                  <th className="px-4 py-4 w-20 text-center">Date</th>
                                  <th className="px-4 py-4 border-l bg-slate-100/50">項目</th>
                                  <th className="px-4 py-4 border-l">勤務表 (Schedule)</th>
                                  <th className="px-4 py-4 border-l">日報 (Report)</th>
                                  <th className="px-4 py-4 border-l text-center w-24">差異</th>
                                </tr>
                              </thead>
                              <tbody className="divide-y divide-slate-100 text-xs">
                                {comparisonData.map(({ day, weekday, rowColor, sch, rep, diffOvertime, diffRegular, diffNight, hasHolidayWork, isSpecialCase, warningMessage }) => {
                                  const statusColor = sch.status?.includes('休') ? 'bg-rose-50 text-rose-600' : 'bg-slate-100 text-slate-600';
                                  const isFlex = settings.flexEmployees.includes(normalizeName(currentEmployee.employeeName)) || (settings.nameMappings && settings.nameMappings.some(m => normalizeName(m.nippo) === normalizeName(currentEmployee.employeeName) && settings.flexEmployees.includes(normalizeName(m.kintai))));
                                  
                                  return (
                                    <tr key={day} className={`hover:opacity-80 transition-colors ${rowColor} ${warningMessage ? 'bg-amber-50' : ''}`}>
                                      <td className="px-4 py-4 font-mono font-bold text-slate-500 text-center text-lg">
                                        {day} <span className="text-xs ml-1">{weekday}</span>
                                      </td>
                                      <td className="px-4 py-4 border-l bg-slate-50/30"><div className="flex flex-col gap-2"><span className="text-[10px] font-bold text-slate-400 uppercase">ステータス</span><span className="text-[10px] font-bold text-slate-400 uppercase">時間帯</span><span className="text-[10px] font-bold text-slate-400 uppercase">所定内</span><span className="text-[10px] font-bold text-slate-400 uppercase">時間外</span><span className="text-[10px] font-bold text-slate-400 uppercase">深夜</span><span className="text-[10px] font-bold text-slate-400 uppercase">時間年休</span></div></td>
                                      <td className="px-4 py-4 border-l"><div className="flex flex-col gap-2"><div className="h-5">{sch.status && <span className={`text-[9px] px-2 py-0.5 rounded font-bold ${statusColor}`}>{sch.status}</span>}</div><div className="font-mono h-4 text-slate-600">{sch.startTime ? `${sch.startTime}-${sch.endTime}` : '-'}</div><div className="font-mono font-bold text-slate-700">{formatSpecialTime(sch.regularTime)}</div><div className="font-mono font-bold text-slate-700">{formatSpecialTime(sch.overtime)}</div><div className="font-mono text-slate-400">{formatSpecialTime(sch.nightTime)}</div><div className="font-mono text-slate-400 text-[10px]">{sch.timeAnnualLeave > 0 ? formatSpecialTime(sch.timeAnnualLeave) : '-'}</div></div></td>
                                      <td className="px-4 py-4 border-l"><div className="flex flex-col gap-2"><div className="h-5">{hasHolidayWork && <span className="text-[9px] px-2 py-0.5 rounded font-bold bg-amber-100 text-amber-700">休出あり</span>}</div><div className="font-mono h-4 text-slate-400 text-[10px]">{rep.startTime ? '記録あり' : '-'}</div><div className="font-mono font-bold text-blue-600">{formatSpecialTime(isFlex ? (rep.regularTime || 0) + (rep.overtime || 0) : rep.regularTime)}</div><div className="font-mono font-bold text-blue-600">{isFlex ? '-' : formatSpecialTime(rep.overtime)}</div><div className="font-mono text-slate-400">{formatSpecialTime(rep.nightTime)}</div><div className="h-4"></div></div></td>
                                      <td className="px-4 py-4 border-l text-center align-middle"><div className="flex flex-col gap-2 items-center justify-center h-full"><div className="h-5"></div><div className="h-4"></div>
                                        <div className={`font-mono font-bold flex items-center gap-1 ${Math.abs(diffRegular) > 0.01 || warningMessage ? (warningMessage ? 'text-amber-500' : 'text-rose-500') : 'text-emerald-500 opacity-20'}`}>
                                          {Math.abs(diffRegular) > 0.01 ? formatSpecialTime(diffRegular) : (isSpecialCase ? <span className="text-[9px] bg-emerald-100 text-emerald-600 px-1 rounded">夜業OK</span> : (warningMessage ? '確認' : 'OK'))}
                                          {warningMessage && <span title={warningMessage} className="text-amber-500 cursor-help"><AlertTriangle className="w-4 h-4"/></span>}
                                        </div>
                                        <div className={`font-mono font-bold ${Math.abs(diffOvertime) > 0.01 ? 'text-rose-500' : 'text-emerald-500 opacity-20'}`}>{isFlex ? (sch.overtime > 0 ? 'NG' : 'OK') : (Math.abs(diffOvertime) > 0.01 ? formatSpecialTime(diffOvertime) : 'OK')}</div>
                                        <div className={`font-mono font-bold ${Math.abs(diffNight) > 0.01 ? 'text-rose-500' : 'text-emerald-500 opacity-20'}`}>{Math.abs(diffNight) > 0.01 ? formatSpecialTime(diffNight) : 'OK'}</div>
                                        <div className="h-4"></div>
                                      </div></td>
                                    </tr>
                                  );
                                })}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                </div>
              </div>
            )}
          </main>
          <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} settings={settings} onSave={setSettings} />
          <HelpModal isOpen={showHelp} onClose={() => setShowHelp(false)} />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
