<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>勤怠・日報比較ツール (Ver.9.24)</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  
  <!-- Babel (JSX変換用) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- SheetJS (Excel操作用) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    html, body, #root {
      height: 100%;
      overflow: hidden;
    }
    body {
      background-color: #f8fafc; /* bg-slate-50 */
    }
    /* モーダル用のアニメーション */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-overlay {
      animation: fadeIn 0.2s ease-out;
    }
    /* スクロールバーのカスタマイズ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    /* テーブル行の高さ固定用 */
    .row-h {
      height: 1.5rem; /* h-6相当 */
      display: flex;
      align-items: center;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useRef, useEffect, useCallback } = React;

    // --- アイコン定義 ---
    const IconWrapper = ({ children, className = "w-5 h-5", ...props }) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
    );
    const FileText = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><line x1="10" y1="9" x2="8" y2="9" /></IconWrapper>;
    const Users = (p) => <IconWrapper {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></IconWrapper>;
    const CheckCircle2 = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></IconWrapper>;
    const ChevronRight = (p) => <IconWrapper {...p}><path d="m9 18 6-6-6-6" /></IconWrapper>;
    const Upload = (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></IconWrapper>;
    const Loader2 = ({ className, ...p }) => <IconWrapper className={`${className} animate-spin`} {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></IconWrapper>;
    const Zap = (p) => <IconWrapper {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></IconWrapper>;
    const Table = (p) => <IconWrapper {...p}><path d="M12 3v18" /><rect width="18" height="18" x="3" y="3" rx="2" /><path d="M3 9h18" /><path d="M3 15h18" /></IconWrapper>;
    const FileSpreadsheet = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M8 13h2" /><path d="M8 17h2" /><path d="M14 13h2" /><path d="M14 17h2" /></IconWrapper>;
    const X = (p) => <IconWrapper {...p}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconWrapper>;
    const Trash2 = (p) => <IconWrapper {...p}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></IconWrapper>;
    const Settings = (p) => <IconWrapper {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
    const Save = (p) => <IconWrapper {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
    const Download = (p) => <IconWrapper {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconWrapper>;
    const AlertTriangle = (p) => <IconWrapper {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconWrapper>;
    const Clock = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></IconWrapper>;
    const HelpCircle = (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" /></IconWrapper>;
    const CalendarCheck = (p) => <IconWrapper {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /><path d="m9 16 2 2 4-4" /></IconWrapper>;
    const FolderInput = (p) => <IconWrapper {...p}><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><path d="M12 10v6"/><path d="M9 13h6"/></IconWrapper>;
    const FileWarning = (p) => <IconWrapper {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /><path d="M12 18v-6" /><path d="M12 8h.01" /></IconWrapper>;
    const RotateCcw = (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>;

    const useSheetJS = () => {
      const [xlsx, setXlsx] = useState(null);
      useEffect(() => {
        if (window.XLSX) { setXlsx(window.XLSX); return; }
        const interval = setInterval(() => {
          if (window.XLSX) { setXlsx(window.XLSX); clearInterval(interval); }
        }, 100);
        return () => clearInterval(interval);
      }, []);
      return xlsx;
    };

    // --- ヘルパー関数 ---
    const parseSpecialTime = (val) => {
      if (val === null || val === undefined || val === '' || val === '-') return 0;
      const str = String(val).trim().replace(',', '.');
      if (str.includes(':')) {
        const [h, m] = str.split(':').map(Number);
        return !isNaN(h) && !isNaN(m) ? h + (m / 60) : 0;
      }
      const floatVal = parseFloat(str);
      if (isNaN(floatVal)) return 0;
      const hours = Math.floor(floatVal);
      const minutes = Math.round((floatVal - hours) * 100);
      return hours + (minutes / 60);
    };

    const formatSpecialTime = (decimalHours) => {
      if (!decimalHours && decimalHours !== 0) return '-';
      const sign = decimalHours < 0 ? '-' : '';
      const absHours = Math.abs(decimalHours);
      const totalMinutes = Math.round(absHours * 60);
      const normH = Math.floor(totalMinutes / 60);
      const normM = totalMinutes % 60;
      return sign + (normH + (normM / 100)).toFixed(2);
    };
    
    const formatTimeStr = (decimalHours) => {
       if (!decimalHours && decimalHours !== 0) return '';
       let val = decimalHours;
       if (val < 0) val += 24;
       if (val >= 24) val -= 24;
       const h = Math.floor(val);
       const m = Math.round((val - h) * 60);
       return `${h}:${m.toString().padStart(2, '0')}`;
    };

    const normalizeId = (id) => {
      if (!id) return '';
      const halfWidth = String(id).replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
      return halfWidth.replace(/^0+/, '').trim();
    };

    const normalizeName = (name) => {
      if (!name) return '';
      return String(name).replace(/[\s\u3000]+/g, '');
    };

    // --- モーダルコンポーネント ---
    const HelpModal = ({ isOpen, onClose }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 modal-overlay" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
            <div className="p-6 border-b flex justify-between items-center bg-slate-50">
              <h2 className="text-xl font-bold flex items-center gap-2 text-indigo-700"><HelpCircle className="w-6 h-6" /> 操作ガイド・判定ルール</h2>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X className="w-6 h-6" /></button>
            </div>
            <div className="p-8 overflow-y-auto text-sm leading-relaxed text-slate-700 space-y-8">
                {/* 以前のヘルプ内容と同じため省略（維持） */}
                <p>勤怠データ（勤務表・服務簿）と工事日報のデータを照合し、不整合を検出します。</p>
            </div>
            <div className="p-6 border-t bg-slate-50 text-right">
              <button onClick={onClose} className="px-8 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all">閉じる</button>
            </div>
          </div>
        </div>
      );
    };

    const SettingsModal = ({ isOpen, onClose, settings, onSave, onReset }) => {
      const [managersText, setManagersText] = useState('');
      const [flexText, setFlexText] = useState('');
      const [mappings, setMappings] = useState([]);
      const fileInput = useRef(null);

      useEffect(() => {
        if (isOpen) {
          setManagersText(settings.managers.join('\n'));
          setFlexText(settings.flexEmployees ? settings.flexEmployees.join('\n') : '');
          setMappings(settings.nameMappings);
        }
      }, [isOpen, settings]);

      const handleSave = () => {
        const newManagers = managersText.split('\n').map(s => normalizeName(s)).filter(s => s);
        const newFlex = flexText.split('\n').map(s => normalizeName(s)).filter(s => s);
        onSave({
          managers: newManagers,
          flexEmployees: newFlex,
          nameMappings: mappings.filter(m => m.nippo && m.kintai)
        });
        onClose();
      };

      const addMapping = () => setMappings([...mappings, { nippo: '', kintai: '' }]);
      const updateMapping = (idx, field, val) => {
        const newMappings = [...mappings];
        newMappings[idx][field] = val;
        setMappings(newMappings);
      };
      const removeMapping = (idx) => setMappings(mappings.filter((_, i) => i !== idx));

      const exportSettings = () => {
        const data = {
          managers: managersText.split('\n').map(s => s.trim()).filter(s => s),
          flexEmployees: flexText.split('\n').map(s => s.trim()).filter(s => s),
          nameMappings: mappings
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'attendance_settings.json';
        a.click();
      };

      const importSettings = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            onSave(data);
            if (data.managers) setManagersText(data.managers.join('\n'));
            if (data.flexEmployees) setFlexText(data.flexEmployees.join('\n'));
            if (data.nameMappings) setMappings(data.nameMappings);
          } catch (err) { alert('設定ファイルの読み込みに失敗しました。'); }
        };
        reader.readAsText(file);
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 modal-overlay">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div className="p-6 border-b flex justify-between items-center bg-slate-50">
              <h2 className="text-lg font-bold flex items-center gap-2"><Settings className="w-5 h-5" />詳細設定</h2>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button>
            </div>
            <div className="p-6 overflow-y-auto flex-1 space-y-8">
              <div className="flex gap-3 pb-6 border-b justify-between">
                <div className="flex gap-3">
                  <button onClick={exportSettings} className="flex items-center gap-2 px-3 py-2 text-sm font-bold text-indigo-600 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition-colors"><Download className="w-4 h-4" /> 設定を保存</button>
                  <button onClick={() => fileInput.current.click()} className="flex items-center gap-2 px-3 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition-colors"><Upload className="w-4 h-4" /> 設定を読込</button>
                  <input type="file" ref={fileInput} className="hidden" accept=".json" onChange={importSettings} />
                </div>
                <button onClick={onReset} className="flex items-center gap-2 px-3 py-2 text-sm font-bold text-rose-600 bg-rose-50 rounded-lg hover:bg-rose-100 transition-colors border border-rose-200"><RotateCcw className="w-4 h-4" /> 設定を初期化</button>
              </div>
              <div className="grid grid-cols-2 gap-6">
                <div>
                  <h3 className="font-bold text-sm text-slate-700 mb-2">管理職リスト</h3>
                  <textarea value={managersText} onChange={e => setManagersText(e.target.value)} className="w-full h-32 p-3 border rounded-xl text-sm font-mono focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50" placeholder="氏名(1行1名)" />
                </div>
                <div>
                  <h3 className="font-bold text-sm text-slate-700 mb-2">フレックス対象者</h3>
                  <textarea value={flexText} onChange={e => setFlexText(e.target.value)} className="w-full h-32 p-3 border rounded-xl text-sm font-mono focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50" placeholder="氏名(1行1名)" />
                </div>
              </div>
              <div>
                <h3 className="font-bold text-sm text-slate-700 mb-2">旧姓・別名マッピング</h3>
                <p className="text-xs text-slate-500 mb-2">日報(旧姓) → 勤務表(新姓) に変換</p>
                <div className="space-y-2">
                  {mappings.map((m, i) => (
                    <div key={i} className="flex gap-2 items-center">
                      <input value={m.nippo} onChange={e => updateMapping(i, 'nippo', e.target.value)} placeholder="日報(旧姓)" className="flex-1 p-2 border rounded-lg text-sm bg-slate-50" />
                      <span className="text-slate-400">→</span>
                      <input value={m.kintai} onChange={e => updateMapping(i, 'kintai', e.target.value)} placeholder="勤務表(新姓)" className="flex-1 p-2 border rounded-lg text-sm bg-slate-50" />
                      <button onClick={() => removeMapping(i)} className="text-rose-400 hover:text-rose-600"><Trash2 className="w-4 h-4" /></button>
                    </div>
                  ))}
                  <button onClick={addMapping} className="text-xs font-bold text-indigo-600 hover:underline">+ 追加する</button>
                </div>
              </div>
            </div>
            <div className="p-4 border-t bg-slate-50 flex justify-end gap-3">
              <button onClick={onClose} className="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-200 rounded-lg">キャンセル</button>
              <button onClick={handleSave} className="px-6 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-lg shadow-indigo-200">設定を適用</button>
            </div>
          </div>
        </div>
      );
    };

    // --- ロジッククラス ---
    class AttendanceFileParser {
      constructor(xlsx) { 
        this.xlsx = xlsx; 
        this.tempMap = {}; 
      }

      async parseFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = this.xlsx.read(data, { type: 'array', cellDates: false, codepage: 932, cellFormula: false });
              resolve({ workbook, fileName: file.name });
            } catch (error) { reject(error); }
          };
          reader.readAsArrayBuffer(file);
        });
      }

      getOrInitEntry(name, id, sourceType, settings) {
        let normName = normalizeName(name);
        let displayName = name;

        if (settings && settings.nameMappings) {
            const mapping = settings.nameMappings.find(m => 
              normalizeName(m.kintai) === normName || normalizeName(m.nippo) === normName
            );
            if (mapping) {
              normName = normalizeName(mapping.nippo);
              displayName = mapping.nippo;
            }
        }

        if (!normName) return null;

        if (!this.tempMap[normName]) {
          this.tempMap[normName] = {
            normalizedName: normName,
            displayName: displayName, 
            ids: { service: null, schedule: null, report: null },
            schedule: [],
            report: [],
            serviceRecord: [],
            rawServiceData: { name: name, days: {} },
            warnings: []
          };
        }
        
        const entry = this.tempMap[normName];
        if (id) {
            const normId = normalizeId(id);
            if (sourceType === 'service') entry.ids.service = normId;
            if (sourceType === 'schedule') entry.ids.schedule = normId;
            if (sourceType === 'report') entry.ids.report = normId;
        }
        return entry;
      }

      upsertRecord(array, record) {
        const idx = array.findIndex(r => r.day === record.day);
        if (idx >= 0) {
          const existing = array[idx];
          array[idx] = {
            ...existing, ...record,
            regularTime: (existing.regularTime || 0) + (record.regularTime || 0),
            overtime: (existing.overtime || 0) + (record.overtime || 0),
            nightTime: (existing.nightTime || 0) + (record.nightTime || 0),
            holidayWork: (existing.holidayWork || 0) + (record.holidayWork || 0),
            types: record.types ? [...new Set([...(existing.types||[]), ...record.types])] : (existing.types || [])
          };
        } else { 
            array.push(record); 
        }
      }

      upsertServiceRecord(array, record) {
        const idx = array.findIndex(r => r.day === record.day);
        if (idx >= 0) {
            array[idx] = record;
        } else {
            array.push(record);
        }
      }

      extractYearMonth(rows) {
        for (let i = 0; i < 50 && i < rows.length; i++) {
          const rowStr = (rows[i] || []).join(' ');
          const m = rowStr.match(/(\d{4})[\u5e74/](\d{1,2})/); 
          if (m) return `${m[1]}${m[2].padStart(2, '0')}`;
        }
        return null;
      }

      async processFiles(files, settings) {
        this.tempMap = {};
        let detectedYearMonth = null;
        let restoredSettings = null;

        for (const file of files) {
          try {
            const { workbook, fileName } = await this.parseFile(file);
            
            if (workbook.SheetNames.includes("_Metadata")) {
               const metaSheet = workbook.Sheets["_Metadata"];
               const metaRows = this.xlsx.utils.sheet_to_json(metaSheet, {header: 1});
               const getVal = (key) => (metaRows.find(r => r[0] === key) || [])[1];
               
               const sm = getVal("Settings_Managers"), sf = getVal("Settings_Flex"), sn = getVal("Settings_Mappings");
               if (sm || sf || sn) {
                   restoredSettings = {
                       managers: sm ? JSON.parse(sm) : settings.managers,
                       flexEmployees: sf ? JSON.parse(sf) : settings.flexEmployees,
                       nameMappings: sn ? JSON.parse(sn) : settings.nameMappings
                   };
                   settings = restoredSettings;
               }
               workbook.SheetNames.forEach(sheetName => {
                   if (sheetName === "_Metadata") return;
                   this.parseRestoredSheet(this.xlsx.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1}), settings);
               });
               continue;
            }

            const rows = this.xlsx.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '', raw: false });
            if (!detectedYearMonth) detectedYearMonth = this.extractYearMonth(rows);

            if (fileName.includes('勤務表')) this.parseSchedule(rows, settings);
            else if (fileName.includes('服務簿')) this.parseServiceRecord(rows, settings);
            else {
              const contentStr = rows.slice(0, 15).map(r => r.join(' ')).join(' ');
              if (contentStr.includes('工事番号') && contentStr.includes('所定内')) this.parseDailyReport_DataFormat(rows, settings);
              else this.parseDailyReport_PrintFormat(rows, settings);
            }
          } catch (e) { console.error(e); }
        }
        
        const finalEmployees = {};
        Object.values(this.tempMap).forEach(entry => {
            let finalId = entry.ids.service || entry.ids.schedule || entry.ids.report || `TEMP-${entry.normalizedName}`;
            if (finalEmployees[finalId]) finalId = `${finalId}_${entry.normalizedName}`;
            finalEmployees[finalId] = {
                employeeId: finalId, employeeName: entry.displayName,
                schedule: entry.schedule, report: entry.report,
                serviceRecord: entry.serviceRecord, rawServiceData: entry.rawServiceData,
                warnings: entry.warnings
            };
        });
        return { employees: finalEmployees, meta: { yearMonth: detectedYearMonth }, restoredSettings };
      }

      parseRestoredSheet(rows, settings) {
          let empName = "", empId = "";
          for(let i=0; i<15; i++) {
              if (rows[i] && rows[i].length > 0) {
                  const cell0 = String(rows[i][0] || ""), cell1 = String(rows[i][1] || "");
                  if (cell0.startsWith("社員名:")) empName = cell0.substring(4).trim();
                  if (cell1.startsWith("ID:")) empId = cell1.substring(3).trim();
              }
          }
          if (!empName) return;
          const entry = this.getOrInitEntry(empName, empId, 'service', settings);
          let headerRow = rows.findIndex(r => r && r[0] === "日付" && String(r[2]).includes("勤務表"));
          if (headerRow === -1) return;

          for(let i=headerRow+1; i<rows.length; i++) {
              const row = rows[i];
              const day = parseInt(row[0]);
              if (isNaN(day)) continue;

              const schTimeParts = String(row[3] || "").split("-");
              let schStatus = String(row[2] || "").replace(/,?\s*時間年休/g, "").trim();
              this.upsertRecord(entry.schedule, {
                  day, weekday: row[1], status: schStatus,
                  startTime: schTimeParts[0] || "", endTime: schTimeParts[1] || "",
                  regularTime: parseSpecialTime(row[4]), overtime: parseSpecialTime(row[5]),
                  nightTime: parseSpecialTime(row[6]), timeAnnualLeave: parseSpecialTime(row[7])
              });

              const svcTimeParts = String(row[9] || "").split("-");
              const svcItems = String(row[8] || "").split(",").map(s => s.trim()).filter(s => s);
              this.upsertServiceRecord(entry.serviceRecord, {
                  day, status: svcItems.filter(s => s.includes("承認") || s.includes("反映")).join(", "),
                  startTime: svcTimeParts[0] || "", endTime: svcTimeParts[1] || "",
                  regularTime: parseSpecialTime(row[10]), overtime: parseSpecialTime(row[11]),
                  nightTime: parseSpecialTime(row[12]), timeAnnualLeave: parseSpecialTime(row[13]),
                  types: svcItems.filter(s => !s.includes("承認") && !s.includes("反映"))
              });

              this.upsertRecord(entry.report, {
                  day, status: row[14] || "", startTime: row[15] || "", 
                  regularTime: parseSpecialTime(row[16]), overtime: parseSpecialTime(row[17]),
                  nightTime: parseSpecialTime(row[18]), nightWorkVal: row[19] || "",
                  holidayWork: String(row[14] || "").includes("休出") ? 1 : 0 
              });
          }
      }

      parseServiceRecord(rows, settings) {
        let colMap = null, headerRowIdx = rows.findIndex(r => r && r.join(',').includes('申請者No') && r.join(',').includes('ステータス'));
        if (headerRowIdx === -1) return;
        const row = rows[headerRowIdx];
        colMap = {
            no: row.findIndex(c => String(c).includes('申請者No')),
            name: row.findIndex(c => String(c).includes('申請者氏名')),
            date: row.findIndex(c => String(c) === '日付'),
            type: row.findIndex(c => String(c) === '種別'),
            start: row.findIndex(c => String(c) === '開始時刻'),
            end: row.findIndex(c => String(c) === '終了時刻'),
            time: row.findIndex(c => String(c) === '時間'),
            breakTime: row.findIndex(c => String(c) === '休憩時間'),
            nightTime: row.findIndex(c => String(c) === '深夜時間'),
            status: row.findIndex(c => String(c) === 'ステータス')
        };

        for (let i = headerRowIdx + 1; i < rows.length; i++) {
            const r = rows[i];
            if (!r || !r[colMap.name]) continue;
            const entry = this.getOrInitEntry(r[colMap.name], r[colMap.no], 'service', settings);
            if (!entry) continue;
            const dayMatch = String(r[colMap.date] || '').match(/(\d+)日/);
            if (!dayMatch) continue;
            const dVal = parseInt(dayMatch[1], 10);
            if (!entry.rawServiceData.days[dVal]) entry.rawServiceData.days[dVal] = [];
            entry.rawServiceData.days[dVal].push({
                type: String(r[colMap.type] || '').trim(),
                time: String(r[colMap.time] || ''),
                startTime: String(r[colMap.start] || '').trim(),
                endTime: String(r[colMap.end] || '').trim(),
                breakTime: String(r[colMap.breakTime] || ''),
                nightTime: String(r[colMap.nightTime] || ''),
                status: String(r[colMap.status] || '').trim()
            });
        }
      }

      parseSchedule(rows, settings) {
        let currentEntry = null, colMap = null;
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i] || [];
          const rowStr = row.join(' ');
          if (rowStr.includes('社員番号')) {
            const idM = rowStr.match(/社員番号[\s:：]*(\d{5,10})/), nameM = rowStr.match(/(?:氏名|氏　名)[\s:：]*([^\s,0-9]+(?:\s+[^\s,0-9]+)?)/);
            if (idM) currentEntry = this.getOrInitEntry(nameM?.[1], idM[1], 'schedule', settings);
          }
          if (!colMap && (row.includes('日付') || row.includes('勤務状況'))) {
            colMap = { day: row.findIndex(c => c && c.includes('日付')), weekday: row.findIndex(c => c && c.includes('曜日')), status: row.findIndex(c => c && c.includes('勤務状況')), start: row.findIndex(c => c && (c.includes('始業') || c.includes('開始'))), end: row.findIndex(c => c && (c.includes('終業') || c.includes('終了'))), breakTime: row.findIndex(c => c && c.includes('休憩') && !c.includes('深夜')), nightBreak: row.findIndex(c => c && c.includes('深夜') && c.includes('休憩')), overtime: row.findIndex(c => c && c.includes('時間外') && !c.includes('法内')), night: row.findIndex(c => c && c.includes('深夜') && !c.includes('休憩')), special: row.findIndex(c => c && c.includes('特殊')), timeAnnualLeave: 14 };
          }
          if (currentEntry && colMap) {
            const dayVal = parseInt(String(row[colMap.day] || '').trim(), 10);
            if (!isNaN(dayVal) && dayVal >= 1 && dayVal <= 31) {
              const startStr = row[colMap.start], endStr = row[colMap.end], bt = parseSpecialTime(row[colMap.breakTime]), nbt = parseSpecialTime(row[colMap.nightBreak]), ot = parseSpecialTime(row[colMap.overtime]), tal = parseSpecialTime(row[colMap.timeAnnualLeave]);
              let reg = 0;
              if (startStr && endStr) {
                let s = parseSpecialTime(startStr), e = parseSpecialTime(endStr);
                if (e < s) e += 24;
                const actual = (e - s) - bt - nbt;
                reg = (tal > 0 && Math.abs(actual + tal - 8.0) < 0.01) ? actual : Math.max(0, actual - ot);
              }
              this.upsertRecord(currentEntry.schedule, { day: dayVal, weekday: String(row[colMap.weekday]||'').trim(), status: String(row[colMap.status]||''), startTime: startStr?String(startStr):'', endTime: endStr?String(endStr):'', overtime: ot, regularTime: reg, timeAnnualLeave: tal, nightTime: parseSpecialTime(row[colMap.night]), special: String(row[colMap.special]||'') });
            }
          }
        }
      }

      parseDailyReport_DataFormat(rows, settings) {
        let currentEntry = null, colMap = null, headerRowIdx = rows.findIndex(r => r.includes('工事番号') && r.includes('所定内'));
        if (headerRowIdx === -1) return;
        for (let i = 0; i < headerRowIdx; i++) {
          const rowStr = rows[i].join(' '), idM = rowStr.match(/社員番号[\s:：]*(\d{5,10})/), nameM = rowStr.match(/社員名[\s:：]*([^\s]+)/);
          if (idM) currentEntry = this.getOrInitEntry(nameM?.[1], idM[1], 'report', settings);
        }
        if (!currentEntry) return;
        const h = rows[headerRowIdx];
        colMap = { day: h.findIndex(c => c === '日'), regular: h.findIndex(c => c.includes('所定内')), overtime: h.findIndex(c => c.includes('時間外')), night: h.findIndex(c => c.includes('深夜')), holiday: h.findIndex(c => c.includes('休日')), nightWork: h.findIndex(c => c.includes('夜業')) };

        for (let i = headerRowIdx + 1; i < rows.length; i++) {
          const r = rows[i];
          const dVal = parseInt(r[colMap.day], 10);
          if (!isNaN(dVal) && dVal >= 1 && dVal <= 31) {
            const reg = parseSpecialTime(r[colMap.regular]), ot = parseSpecialTime(r[colMap.overtime]), hol = parseSpecialTime(r[colMap.holiday]), nf = parseSpecialTime(r[colMap.night]);
            let nv = String(r[colMap.nightWork] || '').trim();
            this.upsertRecord(currentEntry.report, { day: dVal, regularTime: reg, overtime: ot, nightTime: nf, holidayWork: hol, status: (reg+ot+hol > 0)?'出勤':'', startTime: '記録あり', nightWorkVal: (nv==='0'||nv==='0.0')?'':nv });
          }
        }
      }

      parseDailyReport_PrintFormat(rows, settings) {
        let currentEntry = null, COL = { DATE: 3, REGULAR: 26, OVERTIME: 29, NIGHT: 32, HOLIDAY: 35, NAME: 32, AM: 38 };
        let headerRowIdx = rows.findIndex(r => r && r.join('').includes('所定内'));
        if (headerRowIdx === -1) return;
        const h = rows[headerRowIdx];
        COL.REGULAR = h.findIndex(c => /所\s*定\s*内/.test(String(c)));
        COL.OVERTIME = h.findIndex(c => /時\s*間\s*外/.test(String(c)));
        COL.NIGHT = h.findIndex(c => /深\s*夜/.test(String(c)));
        COL.HOLIDAY = h.findIndex(c => /休\s*日/.test(String(c)));
        COL.AM = COL.HOLIDAY + 3;

        const nameRow = rows[7] || [];
        const rawName = String(nameRow[COL.NAME] || "");
        let rawId = null;
        for (let i = 0; i < 10; i++) {
            const match = (rows[i] || []).join(' ').match(/社員番号[\s:：]*(\d{5,10})/);
            if (match) { rawId = match[1]; break; }
        }
        currentEntry = this.getOrInitEntry(rawName, rawId, 'report', settings);
        if (!currentEntry) return;

        for (let i = headerRowIdx + 1; i < rows.length; i++) {
          const r = rows[i];
          const dVal = parseInt(r[COL.DATE], 10);
          if (isNaN(dVal) || dVal === 0) continue;
          const reg = parseSpecialTime(r[COL.REGULAR]), ot = parseSpecialTime(r[COL.OVERTIME]), hol = parseSpecialTime(r[COL.HOLIDAY]), nf = parseSpecialTime(r[COL.NIGHT]);
          let am = String(r[COL.AM] || '').trim().replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
          this.upsertRecord(currentEntry.report, { day: dVal, regularTime: reg, overtime: ot, nightTime: nf, holidayWork: hol, status: (reg+ot+hol > 0)?'出勤':'', startTime: '記録あり', nightWorkVal: (am==='0'||am==='0.0')?'':am });
        }
      }

      aggregateServiceRecord(empId, day, records, isFlexEmployee) {
          const isFlexMode = isFlexEmployee || records.some(r => r.type === 'フレックス');
          const hasNW = records.some(r => r.type && r.type.includes('夜業'));
          if (isFlexMode) {
              let reg = 0, ot = 0, nt = 0, tal = 0, tald = [], st = null, et = null, types = [], status = '';
              records.forEach(r => {
                  if (r.type.includes('自己時間')) return;
                  if (r.type) types.push(r.type); if (r.status) status = r.status;
                  if (r.type.includes('週休出') && r.type.includes('不算入')) reg += parseSpecialTime(r.time);
                  else if (r.type.includes('時間外') || r.type.includes('休日')) ot += parseSpecialTime(r.time);
                  else if (r.type.includes('時間年休')) { tal += parseSpecialTime(r.time); if (r.startTime && r.endTime) tald.push(`${r.startTime}-${r.endTime}`); }
                  else reg += parseSpecialTime(r.time);
                  nt += parseSpecialTime(r.nightTime);
                  if (r.startTime) { const t = parseSpecialTime(r.startTime); if (st === null || t < parseSpecialTime(st)) st = r.startTime; }
                  if (r.endTime) { const t = parseSpecialTime(r.endTime); if (et === null || t > parseSpecialTime(et)) et = r.endTime; }
              });
              if (hasNW) nt += 7.0;
              return { day, regularTime: reg, overtime: ot, nightTime: nt, timeAnnualLeave: tal, timeAnnualLeaveDetails: tald.join(', '), startTime: st || '', endTime: et || '', status, types: [...new Set(types)] };
          } else {
              const isFullLeave = records.some(r => ["年休", "全日年休", "有給休暇", "その他休"].includes(r.type));
              const isComp = records.some(r => ["振休", "振替休日", "非番"].some(k => r.type.includes(k)));
              const base = records.find(r => r.type && (r.type.includes('半休') || r.type === '所定時間変更'));
              let sv = 9.0, ev = 18.0, bv = 1.0;
              if (base) { if (base.startTime) sv = parseSpecialTime(base.startTime); if (base.endTime) ev = parseSpecialTime(base.endTime); if (base.breakTime) bv = parseSpecialTime(base.breakTime); else if (base.type.includes('半休')) bv = 0; }
              let ot = 0, nt = 0, tal = 0, wh = 0, tald = [], types = [], status = '';
              records.forEach(r => {
                  if (r.type.includes('自己時間')) return;
                  if (r.type) types.push(r.type); if (r.status) status = r.status;
                  if (r.type.includes('週休出') && r.type.includes('不算入')) wh += parseSpecialTime(r.time);
                  else if (r.type.includes('時間外') || r.type.includes('休日')) ot += parseSpecialTime(r.time);
                  if (r.type.includes('時間年休')) { tal += parseSpecialTime(r.time); if (r.startTime && r.endTime) { tald.push(`${r.startTime}-${r.endTime}`); const ts = parseSpecialTime(r.startTime), te = parseSpecialTime(r.endTime); if (Math.abs(ts - sv) < 0.01) sv = te; else if (Math.abs(te - ev) < 0.01) ev = ts; } }
                  nt += parseSpecialTime(r.nightTime);
              });
              let csv = 9.0, cev = 18.0; if (base) { if (base.startTime) csv = parseSpecialTime(base.startTime); if (base.endTime) cev = parseSpecialTime(base.endTime); }
              records.forEach(r => {
                  if (r.type.includes('自己時間')) return;
                  if (!(r.type.includes('週休出') && r.type.includes('不算入')) && (r.type.includes('時間外') || r.type.includes('休日'))) {
                      if (r.endTime) { let t = parseSpecialTime(r.endTime); if (t < csv) t += 24.0; if (t > cev) cev = t; }
                      if (r.startTime) { let t = parseSpecialTime(r.startTime); if (t < csv && t > 0) csv = t; }
                  }
              });
              if (cev < csv) cev += 24.0;
              let reg = Math.max(0, (cev - csv) - bv - ot - tal);
              if (isFullLeave || isComp) reg = 0; if (wh > 0) reg = wh; if (hasNW) nt += 7.0;
              return { day, regularTime: reg, overtime: ot, nightTime: nt, timeAnnualLeave: tal, timeAnnualLeaveDetails: tald.join(', '), startTime: (isFullLeave||isComp)?'':formatTimeStr(sv), endTime: (isFullLeave||isComp)?'':formatTimeStr(ev), status, types: [...new Set(types)] };
          }
      }
    }

    // --- App コンポーネント ---
    function App() {
      const STORAGE_KEY = 'attendance_tool_settings_v1';
      const [files, setFiles] = useState([]);
      const [isProcessing, setIsProcessing] = useState(false);
      const [employees, setEmployees] = useState({}); 
      const [fileMeta, setFileMeta] = useState({}); 
      const [selectedId, setSelectedId] = useState(null);
      const [view, setView] = useState('input');
      const [showSettings, setShowSettings] = useState(false);
      const [showHelp, setShowHelp] = useState(false);
      const [checkMode, setCheckMode] = useState('full');
      const [settings, setSettings] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : { managers: [], flexEmployees: [], nameMappings: [] };
      });
      const [mismatchListOpen, setMismatchListOpen] = useState(false);
      const [missingListOpen, setMissingListOpen] = useState(false); 
      const fileInputRef = useRef(null);
      const folderInputRef = useRef(null);
      const xlsx = useSheetJS();

      useEffect(() => {
        if (folderInputRef.current) {
          folderInputRef.current.setAttribute('webkitdirectory', '');
          folderInputRef.current.setAttribute('directory', '');
        }
      }, [view]);

      const onFileChange = (e) => setFiles(prev => [...prev, ...Array.from(e.target.files || [])]);
      const removeFile = (index) => setFiles(prev => prev.filter((_, i) => i !== index));

      const recalcEmployees = useCallback((currentEmployees, newSettings) => {
        if (!xlsx) return {}; 
        const parser = new AttendanceFileParser(xlsx); 
        const newMap = {};

        Object.values(currentEmployees).forEach(emp => {
          let normName = normalizeName(emp.employeeName), targetName = emp.employeeName;
          if (newSettings.nameMappings) {
            const m = newSettings.nameMappings.find(m => normalizeName(m.kintai) === normName || normalizeName(m.nippo) === normName);
            if (m) { normName = normalizeName(m.nippo); targetName = m.nippo; }
          }
          if (!newMap[normName]) {
            newMap[normName] = { employeeId: emp.employeeId, employeeName: targetName, schedule: emp.schedule, report: emp.report, serviceRecord: [], rawServiceData: { name: targetName, days: {} }, warnings: emp.warnings || [], hasRawData: false };
          }
          const target = newMap[normName];
          const merge = (a1, a2) => {
             const res = [...a1];
             a2.forEach(item => { const idx = res.findIndex(r => r.day === item.day); if (idx >= 0) res[idx] = { ...res[idx], ...item, types: [...new Set([...(res[idx].types||[]), ...(item.types||[])])] }; else res.push(item); });
             return res;
          };
          target.schedule = merge(target.schedule, emp.schedule);
          target.report = merge(target.report, emp.report);
          if (emp.warnings) emp.warnings.forEach(w => { if (!target.warnings.includes(w)) target.warnings.push(w); });
          if (emp.rawServiceData?.days) { Object.assign(target.rawServiceData.days, emp.rawServiceData.days); if (Object.keys(emp.rawServiceData.days).length > 0) target.hasRawData = true; }
          if (!target.hasRawData) target.serviceRecord = merge(target.serviceRecord, emp.serviceRecord);
        });
        
        Object.values(newMap).forEach(emp => {
            const name = normalizeName(emp.employeeName);
            // 属性の確定
            emp.isManager = newSettings.managers.includes(name);
            emp.isFlex = newSettings.flexEmployees.includes(name);
            // 服務簿の再計算（引継いだ生データを使用）
            if (emp.hasRawData) {
                emp.serviceRecord = []; 
                Object.keys(emp.rawServiceData.days).forEach(dayKey => {
                    const day = parseInt(dayKey, 10);
                    const record = parser.aggregateServiceRecord(null, day, emp.rawServiceData.days[dayKey], emp.isFlex);
                    parser.upsertServiceRecord(emp.serviceRecord, record);
                });
            }
        });
        
        const finalObj = {};
        Object.values(newMap).forEach(e => { finalObj[e.employeeId] = e; });
        return finalObj;
      }, [xlsx]);

      const handleSaveSettings = (newSettings) => {
        setSettings(newSettings);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(newSettings));
        setEmployees(prev => recalcEmployees(prev, newSettings));
      };

      const handleResetSettings = () => {
        if(!confirm('設定を初期化しますか？')) return;
        const ds = { managers: [], flexEmployees: [], nameMappings: [] };
        setSettings(ds); localStorage.removeItem(STORAGE_KEY);
        setEmployees(prev => recalcEmployees(prev, ds));
      };

      const handleProcess = async () => {
        if (files.length === 0 || !xlsx) return;
        setIsProcessing(true);
        try {
          const parser = new AttendanceFileParser(xlsx);
          const parsedData = await parser.processFiles(files, settings);
          let finalSettings = settings;
          if (parsedData.restoredSettings) {
              finalSettings = parsedData.restoredSettings;
              setSettings(finalSettings);
              localStorage.setItem(STORAGE_KEY, JSON.stringify(finalSettings));
          }
          // 解析直後に再計算を強制し、属性と計算値を確定させる
          const finalEmployees = recalcEmployees(parsedData.employees, finalSettings);
          setEmployees(finalEmployees); 
          setFileMeta(parsedData.meta || {});
          setFiles([]); setView('dashboard');
        } catch (error) { alert(`エラー: ${error.message}`); } finally { setIsProcessing(false); }
      };

      const handleExport = () => {
        if (!xlsx) return;
        const wb = xlsx.utils.book_new(), limitDay = checkMode === 'day20' ? 20 : 31;
        const metaRows = [["Property", "Value"], ["ExportVersion", "9.24"], ["Settings_Managers", JSON.stringify(settings.managers)], ["Settings_Flex", JSON.stringify(settings.flexEmployees)], ["Settings_Mappings", JSON.stringify(settings.nameMappings)]];
        xlsx.utils.book_append_sheet(wb, xlsx.utils.aoa_to_sheet(metaRows), "_Metadata");

        Object.values(employees).forEach(emp => {
          const rows = [], scheduleMap = {}, serviceMap = {}, results = [];
          emp.schedule.forEach(s => scheduleMap[s.day] = s); emp.serviceRecord.forEach(s => serviceMap[s.day] = s);
          for (let day = 1; day <= limitDay; day++) {
             const sch = scheduleMap[day] || {}, rep = emp.report.find(r => r.day === day) || {}, svc = serviceMap[day] || {};
             if (!sch.status && !rep.status && !svc.status && !sch.overtime && !rep.overtime && !svc.startTime && !sch.regularTime && !rep.regularTime) continue;
             const check = checkDailyMismatch(sch, rep, svc, emp.isManager, emp.isFlex, scheduleMap[day+1], serviceMap[day+1]);
             results.push({ day, weekday: sch.weekday||'', sch, rep, svc, check });
          }
          rows.push([`社員名: ${emp.employeeName}`, `ID: ${emp.employeeId}`], [`対象年月: ${fileMeta.yearMonth || '不明'}`], ["日付", "曜日", "【勤務表】ステータス(全)", "【勤務表】開始-終了", "【勤務表】所定内", "【勤務表】時間外", "【勤務表】深夜", "【勤務表】時間年休", "【服務簿】ステータス(全)", "【服務簿】開始-終了", "【服務簿】所定内", "【服務簿】時間外", "【服務簿】深夜", "【服務簿】時間年休", "【日報】ステータス(全)", "【日報】開始", "【日報】所定内", "【日報】時間外", "【日報】深夜", "【日報】夜業値", "判定", "警告メッセージ"]);
          results.forEach(r => {
             rows.push([r.day, r.weekday, r.sch.status, (r.sch.startTime?`${r.sch.startTime}-${r.sch.endTime}`:''), formatSpecialTime(r.sch.regularTime), formatSpecialTime(r.sch.overtime), formatSpecialTime(r.sch.nightTime), formatSpecialTime(r.sch.timeAnnualLeave), (r.svc.types?r.svc.types.join(','):''), (r.svc.startTime?`${r.svc.startTime}-${r.svc.endTime}`:''), formatSpecialTime(r.svc.regularTime), formatSpecialTime(r.svc.overtime), formatSpecialTime(r.svc.nightTime), formatSpecialTime(r.svc.timeAnnualLeave), r.rep.status, r.rep.startTime, formatSpecialTime(r.rep.regularTime), formatSpecialTime(r.rep.overtime), formatSpecialTime(r.rep.nightTime), r.rep.nightWorkVal, r.check.hasMismatch?'NG':'OK', r.check.warningMessage||'']);
          });
          xlsx.utils.book_append_sheet(wb, xlsx.utils.aoa_to_sheet(rows), emp.employeeName.slice(0, 30));
        });
        xlsx.writeFile(wb, `勤怠比較結果_${fileMeta.yearMonth || 'export'}.xlsx`);
      };

      const employeeList = useMemo(() => Object.values(employees), [employees]);
      const currentEmployee = employees[selectedId] || employeeList[0];

      // --- 修正: comparisonData 内の属性判定を排除し、保存された属性を使用 ---
      const comparisonData = useMemo(() => {
        if (!currentEmployee) return [];
        
        // recalcEmployees で既に確定・保存されている属性を取り出す
        const { isManager, isFlex } = currentEmployee; 
        
        const limitDay = checkMode === 'day20' ? 20 : 31;
        const result = Array.from({ length: 31 }, (_, i) => i + 1)
          .filter(day => day <= limitDay)
          .map(day => {
            const sch = currentEmployee.schedule.find(r => r.day === day) || {};
            const rep = currentEmployee.report.find(r => r.day === day) || {};
            const svc = currentEmployee.serviceRecord.find(r => r.day === day) || {}; 
            // 確定した属性を checkDailyMismatch に渡す
            const check = checkDailyMismatch(sch, rep, svc, isManager, isFlex, currentEmployee.schedule.find(r => r.day === day + 1), currentEmployee.serviceRecord.find(r => r.day === day + 1));
            let rC = (sch.status?.includes('加休') || (sch.weekday || '').includes('日')) ? 'bg-red-50' : ((sch.weekday || '').includes('土') ? 'bg-blue-50' : '');
            return { day, weekday: sch.weekday || '', rowColor: rC, sch, rep, svc, ...check, hasData: sch.status || rep.status || svc.status || sch.overtime > 0 || rep.overtime > 0 || svc.startTime || sch.regularTime > 0 || rep.regularTime > 0, hasHolidayWork: rep.holidayWork > 0, hasNightWork: check.isNightWorkDay };
          }).filter(d => d.hasData);
        
        let nwD = 0, hbD = 0, whW = 0, cpL = 0, satHbC = 0, satHbM = false;
        result.forEach(r => {
            if (r.isNightWorkDay) nwD++;
            if (r.base.types ? r.base.types.some(t => t.includes('非番')) : (r.base.status && r.base.status.includes('非番'))) hbD++;
            if (r.base.types && r.base.types.some(t => t.includes('週休出') && t.includes('不算入'))) whW++;
            if (r.base.types && r.base.types.some(t => t.includes('振休') || t.includes('振替休日'))) cpL++;
            else if (!r.base.types && r.base.status && (r.base.status.includes('振休') || r.base.status.includes('振替休日'))) cpL++;
            if (r.weekday.includes('土') && (r.svc.types ? r.svc.types.some(t => t.includes('非番')) : (r.svc.status && r.svc.status.includes('非番')))) {
                satHbC++;
                const mondayRow = result.find(rr => rr.day === r.day + 2);
                let hasM = mondayRow && ((mondayRow.svc.types && mondayRow.svc.types.some(t => t.includes('週休出') || t.includes('振休'))) || (mondayRow.svc.status && mondayRow.svc.status.includes('振休')));
                if (!hasM) satHbM = true;
            }
        });
        return { rows: result, summary: { nightWorkDays: nwD, hibanDays: hbD, nightWorkMismatch: (!isManager && nwD !== hbD), weekHolidayWorkCount: whW, compensatoryLeaveCount: cpL, compensatoryLeaveMismatch: (whW !== cpL), saturdayHibanCount: satHbC, saturdayHibanMismatch: satHbM }, isManager, isFlex };
      }, [currentEmployee, checkMode]);

      return (
        <div className="h-full w-full bg-slate-50 text-slate-900 p-4 md:p-6 flex flex-col overflow-hidden">
          <header className="shrink-0 max-w-7xl mx-auto w-full mb-4 flex flex-col md:flex-row items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <div className="bg-indigo-600 p-2 rounded-xl text-white shadow-lg"><Zap className="w-6 h-6" /></div>
              <div><h1 className="text-xl font-bold text-slate-800">勤怠データ照合ツール (Ver.9.24)</h1><p className="text-xs text-slate-500 font-medium">ロジック一本化・不整合解消版</p></div>
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setShowHelp(true)} className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-bold bg-white text-emerald-600 border border-emerald-200 hover:bg-emerald-50 transition-colors"><HelpCircle className="w-4 h-4" /> ヘルプ</button>
              <button onClick={() => setShowSettings(true)} className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold bg-white text-slate-600 border hover:bg-slate-50 transition-colors"><Settings className="w-4 h-4" /> 設定</button>
              <button onClick={handleExport} disabled={employeeList.length === 0} className="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-bold bg-white text-indigo-600 border border-indigo-200 hover:bg-indigo-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"><Download className="w-4 h-4" /> 結果保存</button>
              <div className="flex bg-white p-1 rounded-xl border border-slate-200 shadow-sm">
                <button onClick={() => setView('input')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${view === 'input' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>ファイル登録</button>
                <button onClick={() => setView('dashboard')} disabled={employeeList.length === 0} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${view === 'dashboard' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50 disabled:opacity-30'}`}>比較ボード</button>
              </div>
            </div>
          </header>
          
          <main className="flex-1 w-full max-w-7xl mx-auto overflow-hidden flex flex-col min-h-0">
            {view === 'input' ? (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto h-full content-start">
                <div className="lg:col-span-2 space-y-6">
                  <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 relative overflow-hidden">
                    <div className="flex items-center gap-2 mb-4"><div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><FileSpreadsheet className="w-5 h-5" /></div><h2 className="font-bold">ファイルアップロード</h2></div>
                    <div className="flex gap-4">
                      <div className={`flex-1 border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center transition-all cursor-pointer group ${!xlsx ? 'opacity-50 pointer-events-none' : 'hover:border-indigo-400 hover:bg-indigo-50/50'}`} onClick={() => fileInputRef.current?.click()}>
                        <input type="file" ref={fileInputRef} className="hidden" multiple accept=".xls, .xlsx, .csv" onChange={onFileChange} />
                        <Upload className="w-8 h-8 mx-auto mb-2 text-slate-300 group-hover:text-indigo-500 transition-colors" />
                        <p className="text-sm font-bold text-slate-600">ファイルを選択</p>
                      </div>
                      <div className={`flex-1 border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center transition-all cursor-pointer group ${!xlsx ? 'opacity-50 pointer-events-none' : 'hover:border-indigo-400 hover:bg-indigo-50/50'}`} onClick={() => folderInputRef.current?.click()}>
                        <input type="file" ref={folderInputRef} className="hidden" multiple onChange={onFileChange} />
                        <FolderInput className="w-8 h-8 mx-auto mb-2 text-slate-300 group-hover:text-indigo-500 transition-colors" />
                        <p className="text-sm font-bold text-slate-600">フォルダを選択</p>
                      </div>
                    </div>
                  </div>
                  <button onClick={handleProcess} disabled={isProcessing || files.length === 0} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white font-black rounded-2xl transition-all flex items-center justify-center gap-3 shadow-xl shadow-indigo-200 active:scale-95">{isProcessing ? "解析中..." : "解析を実行"}</button>
                </div>
                <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 h-fit"><h3 className="font-bold mb-4 flex items-center gap-2 border-b pb-4"><Users className="w-5 h-5 text-indigo-600" />解析済みデータ ({employeeList.length})</h3>
                  <div className="space-y-2 max-h-[600px] overflow-y-auto">{employeeList.map((emp, i) => (<div key={i} className="p-3 border rounded-xl bg-slate-50/50"><div><div className="text-[9px] font-mono text-slate-400">ID: {emp.employeeId}</div><div className="text-sm font-bold text-slate-700">{emp.employeeName}</div></div></div>))}</div>
                </div>
              </div>
            ) : (
              <div className="flex flex-col gap-4 h-full overflow-hidden">
                <div className="shrink-0 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-6 items-start">
                  <div className="flex gap-4 p-2">
                    <div className="text-center px-4 border-r"><div className="text-xs text-slate-400 font-bold mb-1">管理職</div><div className="text-2xl font-black text-slate-700">{employeeSummary.managerCount} 名</div></div>
                    <div className="text-center px-4 border-r"><div className="text-xs text-slate-400 font-bold mb-1">一般社員</div><div className="text-2xl font-black text-slate-700">{employeeSummary.generalCount} 名</div></div>
                    <div className="text-center px-4 border-r"><div className="text-xs text-slate-400 font-bold mb-1">フレックス</div><div className="text-2xl font-black text-slate-700">{employeeSummary.flexCount} 名</div></div>
                  </div>
                  <div className="flex-1 w-full space-y-2">
                    <div className={`flex items-center justify-between p-3 rounded-xl cursor-pointer ${employeeSummary.mismatchEmployees.length > 0 ? 'bg-rose-50 text-rose-800' : 'bg-emerald-50 text-emerald-800'}`} onClick={() => setMismatchListOpen(!mismatchListOpen)}>
                      <div className="flex items-center gap-2 font-bold">{employeeSummary.mismatchEmployees.length > 0 ? <AlertTriangle className="w-5 h-5" /> : <CheckCircle2 className="w-5 h-5" />}不整合あり: {employeeSummary.mismatchEmployees.length} 名</div>
                      <ChevronRight className={`w-5 h-5 transition-transform ${mismatchListOpen ? 'rotate-90' : ''}`} />
                    </div>
                    {mismatchListOpen && employeeSummary.mismatchEmployees.length > 0 && <div className="mt-2 p-2 bg-white border rounded-xl shadow-sm grid grid-cols-2 md:grid-cols-4 gap-2 max-h-32 overflow-y-auto">{employeeSummary.mismatchEmployees.map(emp => (<button key={emp.employeeId} onClick={() => selectEmployeeByKey(emp)} className="text-left px-3 py-2 text-sm font-bold text-rose-600 hover:bg-rose-50 rounded-lg truncate flex items-center gap-1">{emp.employeeName}</button>))}</div>}
                  </div>
                </div>
                
                <div className="shrink-0 flex justify-center bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                  <button onClick={() => setCheckMode('full')} className={`flex-1 px-4 py-2 rounded-lg text-sm font-bold transition-all ${checkMode === 'full' ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}>通常 (月末まで)</button>
                  <button onClick={() => setCheckMode('day20')} className={`flex-1 px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 ${checkMode === 'day20' ? 'bg-amber-500 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50'}`}><CalendarCheck className="w-4 h-4" /> 20日締め</button>
                </div>

                <div className="flex-1 flex gap-6 overflow-hidden min-h-0">
                  <aside className="w-64 shrink-0 overflow-y-auto pr-2 pb-4">
                    <h3 className="text-[10px] font-black text-slate-400 px-3 py-1 uppercase tracking-widest sticky top-0 bg-slate-50 z-10">Employee List</h3>
                    <div className="space-y-2">
                    {employeeList.map((emp) => {
                      const key = Object.keys(employees).find(k => employees[k] === emp);
                      return (<button key={key} onClick={() => setSelectedId(key)} className={`w-full p-3 rounded-2xl text-left transition-all flex items-center justify-between border ${selectedId === key ? 'bg-indigo-600 text-white border-indigo-600 shadow-lg scale-105 z-10' : 'bg-white border-slate-200 hover:bg-slate-50'}`}><div className="truncate flex-1"><div className={`text-[9px] font-mono ${selectedId === key ? 'text-indigo-200' : 'text-slate-400'}`}>{emp.employeeId}</div><div className="font-bold truncate text-sm flex items-center gap-1">{emp.employeeName}{emp.isManager && <span className="text-[9px] bg-purple-100 text-purple-700 px-1 rounded ml-1">管</span>}{emp.isFlex && <span className="text-[9px] bg-orange-100 text-orange-700 px-1 rounded ml-1">F</span>}</div></div><ChevronRight className={`w-4 h-4 shrink-0 ${selectedId === key ? 'opacity-100' : 'opacity-20'}`} /></button>);
                    })}
                    </div>
                  </aside>
                  <div className="flex-1 flex flex-col overflow-hidden min-h-0">
                    {!currentEmployee ? (<div className="bg-white h-full rounded-3xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-slate-400">社員を選択してください</div>) : (
                      <div className="flex-1 bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden flex flex-col min-h-0">
                        <div className="p-4 bg-slate-50/50 border-b flex justify-between items-center"><h2 className="font-bold text-slate-700">{currentEmployee.employeeName} の照合結果</h2></div>
                        <div className="overflow-y-auto flex-1 p-4">
                          <div className="grid grid-cols-2 md:grid-cols-6 gap-2 text-xs mb-4">
                             <div className={`p-2 rounded font-bold text-center border ${comparisonData.rows.every(d => Math.abs(d.diffRegular) < 0.01 || d.isSpecialCase) ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-rose-50 text-rose-700 border-rose-100'}`}>所定内: {comparisonData.rows.every(d => Math.abs(d.diffRegular) < 0.01 || d.isSpecialCase) ? 'OK' : 'NG'}</div>
                             <div className={`p-2 rounded font-bold text-center border ${comparisonData.rows.every(d => Math.abs(d.diffOvertime) < 0.01) ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-rose-50 text-rose-700 border-rose-100'}`}>残業: {comparisonData.rows.every(d => Math.abs(d.diffOvertime) < 0.01) ? 'OK' : 'NG'}</div>
                             <div className={`p-2 rounded font-bold text-center border ${comparisonData.rows.every(d => Math.abs(d.diffNight) < 0.01 && !d.nightWorkCheckNG && !d.nightWorkMessage) ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-rose-50 text-rose-700 border-rose-100'}`}>夜業入力: {comparisonData.rows.every(d => Math.abs(d.diffNight) < 0.01 && !d.nightWorkCheckNG && !d.nightWorkMessage) ? 'OK' : 'NG'}</div>
                             <div className={`p-2 rounded font-bold text-center border ${comparisonData.rows.every(d => d.nextDayCheckOK !== false) && !comparisonData.summary.saturdayHibanMismatch ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-rose-50 text-rose-700 border-rose-100'}`}>翌日非番: {comparisonData.rows.every(d => d.nextDayCheckOK !== false) ? 'OK' : 'NG'}</div>
                             <div className={`p-2 rounded font-bold text-center border ${!comparisonData.summary.nightWorkMismatch ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-rose-50 text-rose-700 border-rose-100'}`}>夜業突合: {!comparisonData.summary.nightWorkMismatch ? 'OK' : 'NG'}</div>
                             <div className={`p-2 rounded font-bold text-center border ${!comparisonData.summary.compensatoryLeaveMismatch ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-rose-50 text-rose-700 border-rose-100'}`}>振休突合: {!comparisonData.summary.compensatoryLeaveMismatch ? 'OK' : 'NG'}</div>
                          </div>
                          <table className="w-full text-left border-collapse text-sm">
                            <thead className="sticky top-0 bg-white shadow-sm font-bold text-slate-400"><tr><th className="p-2">日付</th><th className="p-2">項目</th><th className="p-2 border-l">勤務表</th><th className="p-2 border-l">服務簿</th><th className="p-2 border-l">日報</th><th className="p-2 border-l text-center">判定</th></tr></thead>
                            <tbody className="divide-y divide-slate-100">
                              {comparisonData.rows.map(d => {
                                 let schC = d.sch.status?.includes('時間年休') ? 'bg-orange-100 text-orange-800' : (d.sch.status?.includes('休') ? 'bg-rose-100 text-rose-800' : 'bg-slate-100 text-slate-600');
                                 let svcItems = d.svc.types?.join(', ') || ''; let svcStatus = d.svc.status ? `${d.svc.status} [${svcItems}]` : svcItems;
                                 return (
                                   <tr key={d.day} className={`${d.rowColor} ${d.warningMessage ? 'bg-amber-50' : ''}`}>
                                      <td className="p-2 font-bold text-slate-500">{d.day} <span className="text-[10px]">{d.weekday}</span></td>
                                      <td className="p-2 text-[10px] font-bold text-slate-400 leading-tight">所定内<br/>残業<br/>深夜</td>
                                      <td className="p-2 border-l font-mono">
                                          <div className="flex gap-1 mb-1">{d.sch.status && <span className={`text-[9px] px-1 rounded font-bold ${schC}`}>{d.sch.status}</span>}</div>
                                          {formatSpecialTime(d.sch.regularTime)}<br/>{formatSpecialTime(d.sch.overtime)}<br/><span className="text-slate-400">{formatSpecialTime(d.sch.nightTime)}</span>
                                      </td>
                                      <td className="p-2 border-l font-mono">
                                          <div className="mb-1 text-[9px] font-bold text-indigo-600 truncate max-w-[120px]" title={svcStatus}>{svcStatus}</div>
                                          {formatSpecialTime(d.svc.regularTime)}<br/>{formatSpecialTime(d.svc.overtime)}<br/><span className="text-slate-400">{formatSpecialTime(d.svc.nightTime)}</span>
                                      </td>
                                      <td className="p-2 border-l font-mono">
                                          <div className="flex gap-1 mb-1">{d.hasNightWork && <span className="text-[9px] bg-yellow-400 px-1 rounded font-bold">夜業</span>}</div>
                                          {formatSpecialTime(d.rep.regularTime)}<br/>{formatSpecialTime(d.rep.overtime)}<br/><span className="text-slate-400">{formatSpecialTime(d.rep.nightTime)}</span>
                                      </td>
                                      <td className="p-2 border-l text-center">
                                          <div className={`font-bold font-mono ${d.hasMismatch ? 'text-rose-600' : 'text-emerald-600'}`}>{d.hasMismatch ? 'NG' : 'OK'}</div>
                                          {d.warningMessage && <div className="text-[9px] bg-amber-100 text-amber-700 rounded px-1 mt-1">{d.warningMessage}</div>}
                                      </td>
                                   </tr>
                                 );
                              })}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </main>
          <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} settings={settings} onSave={handleSaveSettings} onReset={handleResetSettings} />
          <HelpModal isOpen={showHelp} onClose={() => setShowHelp(false)} />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
